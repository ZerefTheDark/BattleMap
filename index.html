<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="The Dragon Stones - A D&D Battle Map Application" />
    <title>The Dragon Stones - Battle Map</title>
    
    <!-- Embedded minimal CSS framework -->
    <style>
        /* Minimal utility classes inspired by Tailwind */
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .h-screen { height: 100vh; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .w-80 { width: 20rem; }
        .w-5 { width: 1.25rem; }
        .h-5 { height: 1.25rem; }
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mt-3 { margin-top: 0.75rem; }
        .-mt-1 { margin-top: -0.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace; }
        .font-serif { font-family: ui-serif, Georgia, Cambria, 'Times New Roman', Times, serif; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .italic { font-style: italic; }
        .text-center { text-align: center; }
        .text-white { color: rgb(255 255 255); }
        .text-gray-300 { color: rgb(209 213 219); }
        .text-gray-400 { color: rgb(156 163 175); }
        .text-green-400 { color: rgb(74 222 128); }
        .text-yellow-400 { color: rgb(251 191 36); }
        .text-blue-400 { color: rgb(96 165 250); }
        .bg-gray-700 { background-color: rgb(55 65 81); }
        .bg-gray-800 { background-color: rgb(31 41 55); }
        .bg-gray-900 { background-color: rgb(17 24 39); }
        .bg-green-600 { background-color: rgb(22 163 74); }
        .bg-black { background-color: rgb(0 0 0); }
        .bg-opacity-75 { background-color: rgba(0, 0, 0, 0.75); }
        .border { border-width: 1px; }
        .border-2 { border-width: 2px; }
        .border-t { border-top-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-l { border-left-width: 1px; }
        .border-gray-700 { border-color: rgb(55 65 81); }
        .border-green-500 { border-color: rgb(34 197 94); }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0px; right: 0px; bottom: 0px; left: 0px; }
        .inset-x-0 { left: 0px; right: 0px; }
        .bottom-0 { bottom: 0px; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .pointer-events-none { pointer-events: none; }
        .cursor-pointer { cursor: pointer; }
        .flex-wrap { flex-wrap: wrap; }
        .hidden { display: none; }
        .hover\:bg-gray-600:hover { background-color: rgb(75 85 99); }
        .hover\:bg-green-700:hover { background-color: rgb(21 128 61); }
        .hover\:text-white:hover { color: rgb(255 255 255); }
        
        @media (min-width: 640px) {
            .sm\:inline { display: inline; }
        }
    </style>
    
    <style>
        /* Custom Dragon Stones Theme */
        :root {
            --dragon-gold: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            --emerald-magic: linear-gradient(135deg, #10b981, #059669, #047857);
            --dark-stone: linear-gradient(145deg, #0f172a, #1e293b, #334155);
            --dragon-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 4px 16px rgba(0, 0, 0, 0.3);
            --emerald-glow: 0 0 20px rgba(16, 185, 129, 0.4), 0 0 40px rgba(16, 185, 129, 0.2);
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            overflow: hidden;
        }
        
        .dragon-border {
            background: linear-gradient(45deg, #22c55e, #fbbf24, #22c55e);
            padding: 2px;
            border-radius: 8px;
        }
        
        .dragon-border-inner {
            background: #1e293b;
            border-radius: 6px;
            height: 100%;
            width: 100%;
        }
        
        .battle-canvas {
            background: 
                radial-gradient(circle at 20% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #1e293b 0%, #334155 100%);
            cursor: grab;
        }
        
        .battle-canvas:active {
            cursor: grabbing;
        }
        
        /* Legacy styles - kept for any remaining usage */
        .tool-button {
            transition: all 0.2s ease;
        }
        
        .tool-button:hover {
            box-shadow: var(--emerald-glow);
        }
        
        .active-tool {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: var(--emerald-glow);
        }
        
        .decorative-border {
            background: linear-gradient(to right, #fbbf24, #10b981, #fbbf24);
            height: 2px;
        }
        
        .grid-overlay {
            background-image: 
                linear-gradient(rgba(16, 185, 129, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.2) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Modal and Character Sheet Styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }
        
        .modal-content {
            max-height: 90vh;
            max-width: 90vw;
            overflow-y: auto;
        }
        
        .character-sheet {
            background: linear-gradient(145deg, #1e293b, #334155);
            border: 2px solid #10b981;
            box-shadow: var(--dragon-shadow);
        }
        
        .character-sheet-tabs {
            border-bottom: 2px solid #10b981;
        }
        
        .character-sheet-tab {
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .character-sheet-tab:hover {
            background: rgba(16, 185, 129, 0.1);
        }
        
        .character-sheet-tab.active {
            background: rgba(16, 185, 129, 0.2);
            border-bottom-color: #fbbf24;
        }
        
        .stat-block {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
        }
        
        .drag-drop-area {
            border: 2px dashed #10b981;
            background: rgba(16, 185, 129, 0.1);
            transition: all 0.3s ease;
        }
        
        .drag-drop-area.drag-over {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.2);
        }
        
        /* Map Creation Modal Styles */
        .tab-button {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            border-bottom-color: currentColor;
        }
        
        .tab-content {
            min-height: 200px;
        }
        
        .image-gallery-item {
            transition: all 0.2s ease;
        }
        
        .image-gallery-item:hover {
            background-color: #374151 !important;
        }
        
        .token-selected {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
        }
        
        /* Control Center Styles */
        .control-center {
            z-index: 1000;
            width: 420px;
            height: 500px;
            top: 80px;
            right: 20px;
            min-width: 350px;
            min-height: 300px;
            max-width: 700px;
            max-height: 80vh;
            background: linear-gradient(145deg, #1f2937, #374151);
            border: 1px solid #10b981;
            box-shadow: var(--dragon-shadow);
        }
        
        .control-center.dragging {
            opacity: 0.9;
            cursor: move;
            z-index: 1001;
        }
        
        .control-center.resizing {
            pointer-events: none;
        }
        
        .control-center-header {
            background: linear-gradient(135deg, #047857, #059669);
            border-bottom: 1px solid #10b981;
            user-select: none;
        }
        
        .control-center-header:hover {
            background: linear-gradient(135deg, #059669, #10b981);
        }
        
        .control-center-content {
            height: calc(100% - 60px);
            display: flex;
            flex-direction: column;
        }
        
        /* Control Center Tabs */
        .control-tab {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            color: #d1d5db;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            white-space: nowrap;
            flex: 1;
            justify-content: center;
        }
        
        .control-tab:hover {
            color: white;
            background: rgba(75, 85, 99, 0.3);
            border-bottom-color: #fbbf24;
        }
        
        .control-tab.active {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border-bottom-color: #10b981;
        }
        
        .control-tab:focus {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }
        
        /* Control Content Area */
        #control-content {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Chat Messages in Control Center */
        .control-chat-messages {
            height: 200px;
            min-height: 100px;
            background: #374151;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            overflow-y: auto;
            font-size: 0.875rem;
        }
        
        /* Resize Handles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 1001;
        }
        
        .resize-handle-n, .resize-handle-s {
            height: 4px;
            left: 8px;
            right: 8px;
            cursor: ns-resize;
        }
        
        .resize-handle-n {
            top: -2px;
        }
        
        .resize-handle-s {
            bottom: -2px;
        }
        
        .resize-handle-e, .resize-handle-w {
            width: 4px;
            top: 8px;
            bottom: 8px;
            cursor: ew-resize;
        }
        
        .resize-handle-e {
            right: -2px;
        }
        
        .resize-handle-w {
            left: -2px;
        }
        
        .resize-handle-ne, .resize-handle-nw, .resize-handle-se, .resize-handle-sw {
            width: 8px;
            height: 8px;
        }
        
        .resize-handle-ne {
            top: -2px;
            right: -2px;
            cursor: ne-resize;
        }
        
        .resize-handle-nw {
            top: -2px;
            left: -2px;
            cursor: nw-resize;
        }
        
        .resize-handle-se {
            bottom: -2px;
            right: -2px;
            cursor: se-resize;
        }
        
        .resize-handle-sw {
            bottom: -2px;
            left: -2px;
            cursor: sw-resize;
        }
        
        .resize-handle:hover {
            background: rgba(16, 185, 129, 0.3);
        }
        
        /* Module System Styles */
        .module-window {
            position: absolute;
            background: rgb(17 24 39);
            border: 1px solid rgb(55 65 81);
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            min-width: 280px;
            min-height: 200px;
            max-width: 600px;
            max-height: 800px;
            z-index: 100;
        }

        .module-window.dragging {
            user-select: none;
            z-index: 1000;
        }

        .module-window.resizing {
            user-select: none;
        }

        .module-header {
            background: rgb(31 41 55);
            padding: 0.5rem 1rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            cursor: move;
            border-bottom: 1px solid rgb(55 65 81);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .module-header:hover {
            background: rgb(55 65 81);
        }

        .module-content {
            padding: 1rem;
            overflow-y: auto;
            height: calc(100% - 40px);
        }

        .module-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .module-controls button {
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            border: none;
            border-radius: 0.25rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .module-controls .collapse-btn {
            background: rgb(59 130 246);
            color: white;
        }

        .module-controls .collapse-btn:hover {
            background: rgb(37 99 235);
        }

        .module-controls .close-btn {
            background: rgb(239 68 68);
            color: white;
        }

        .module-controls .close-btn:hover {
            background: rgb(220 38 38);
        }

        .module-window.collapsed .module-content {
            display: none;
        }

        .module-window.collapsed {
            height: auto !important;
            min-height: auto;
        }

        /* Module toggle button styles */
        .module-toggle-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgb(31 41 55);
            border: 1px solid rgb(55 65 81);
            border-radius: 0.5rem;
            color: rgb(209 213 219);
            transition: all 0.2s;
            cursor: pointer;
            min-height: 80px;
        }

        .module-toggle-btn:hover {
            background: rgb(55 65 81);
            border-color: rgb(74 222 128);
            color: rgb(74 222 128);
        }

        .module-toggle-btn.active {
            background: rgb(74 222 128);
            color: rgb(17 24 39);
            border-color: rgb(74 222 128);
        }

        .module-toggle-btn .icon {
            font-size: 1.5rem;
        }

        .module-toggle-btn .label {
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Module dice button styles */
        .module-dice-btn {
            background: rgb(31 41 55);
            border: 1px solid rgb(55 65 81);
            color: rgb(209 213 219);
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 600;
        }

        .module-dice-btn:hover {
            background: rgb(55 65 81);
            border-color: rgb(74 222 128);
            color: rgb(74 222 128);
        }

        /* Module recent rolls styles */
        .module-recent-rolls {
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        /* Prevent text selection during drag */
        .chat-window.dragging {
            user-select: none;
        }
        
        .chat-window.resizing {
            user-select: none;
        }
        
        /* Legacy panel tab styles - keeping for compatibility */
        .panel-tab {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .panel-tab:hover {
            background: rgba(16, 185, 129, 0.1);
        }
        
        .active-panel-tab {
            background: rgba(16, 185, 129, 0.2);
            border-bottom-color: #fbbf24 !important;
        }
        
        .panel-content {
            background: linear-gradient(145deg, #1f2937, #374151);
        }
        
        /* ================================================
           CANONICAL BUTTON COMPONENT SYSTEM
           ================================================ */

        /* PRIMARY ACTION BUTTONS - For main interactive elements */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary:focus {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* TOOL BUTTONS - For toolbar selection */
        .btn-tool {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            color: white;
            border: 1px solid transparent;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 3rem;
        }

        .btn-tool:hover {
            background: rgba(75, 85, 99, 0.5);
            border-color: rgba(107, 114, 128, 0.5);
        }

        .btn-tool.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #2563eb;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .btn-tool:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* DICE BUTTONS - Consolidated implementation */
        .btn-dice {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.75rem;
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 2.5rem;
        }

        .btn-dice:hover {
            background: #4b5563;
            border-color: #6b7280;
            transform: translateY(-1px);
        }

        .btn-dice:active {
            background: #10b981;
            border-color: #059669;
            transform: translateY(0);
        }

        .btn-dice:focus {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }

        /* TAB BUTTONS - For panel navigation */
        .btn-tab {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            color: #d1d5db;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .btn-tab:hover {
            background: rgba(16, 185, 129, 0.1);
            color: white;
        }

        .btn-tab.active {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border-bottom-color: #fbbf24;
        }

        .btn-tab:focus {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }

        /* ICON BUTTONS - For small utility actions */
        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: transparent;
            color: #9ca3af;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 2.5rem;
            height: 2.5rem;
        }

        .btn-icon:hover {
            color: white;
            background: rgba(75, 85, 99, 0.3);
        }

        .btn-icon:focus {
            outline: 2px solid #6b7280;
            outline-offset: 2px;
        }

        /* COLOR SELECTION BUTTONS */
        .btn-color {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }

        .btn-color:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .btn-color.selected {
            border-color: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }

        .btn-color:focus {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }

        /* SECONDARY BUTTONS - For supporting actions */
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
            border-color: #6b7280;
        }

        .btn-secondary:focus {
            outline: 2px solid #6b7280;
            outline-offset: 2px;
        }

        .btn-secondary.active {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            border-color: #fbbf24;
        }

        /* DANGER/DELETE BUTTONS */
        .btn-danger {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background: #b91c1c;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }

        .btn-danger:focus {
            outline: 2px solid #dc2626;
            outline-offset: 2px;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 640px) {
            .btn-tool .btn-text {
                display: none;
            }
        }

        /* Enhanced Fog Tool Styles */
        .fog-mode-selector {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
        }
        
        #fog-submenu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            margin-top: 4px;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            min-width: 8rem;
        }
    </style>
</head>
<body>
    <div class="h-screen flex flex-col">
        <!-- Decorative Top Border -->
        <div class="bg-gray-900 text-green-400 text-center py-1 text-xs font-mono">
            üåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏èüåø‚öîÔ∏è
        </div>
        
        <!-- Top Toolbar -->
        <div class="bg-gray-900 border-b-2 border-green-500 shadow-lg py-0 px-1 flex items-center justify-between gap-4 relative">
            <div class="decorative-border absolute inset-x-0 bottom-0"></div>
            
            <!-- Title and Info -->
            <div class="flex items-center gap-2">
                <div class="flex flex-col">
                    <h1 class="text-xl font-bold bg-gradient-to-r from-yellow-400 to-yellow-600 bg-clip-text text-transparent">
                        The Dragon Stones
                    </h1>
                    <p class="text-sm text-gray-400 font-serif italic -mt-1">Chris Marshall</p>
                </div>
                <span id="zoom-badge" class="px-2 py-1 text-xs border border-green-500 text-green-400 rounded">100%</span>
            </div>
            
            <!-- Tool Selection -->
            <div class="flex items-center gap-1 bg-gray-700 rounded-lg p-1">
                <button id="tool-move" class="btn-tool active" title="Pan & Move" aria-label="Pan and move tool, currently active" aria-pressed="true">
                    <span class="icon">‚¨ÖÔ∏è</span>
                    <span class="btn-text hidden sm:inline">Move</span>
                </button>
                <button id="tool-ruler" class="btn-tool" title="Ruler Tool" aria-label="Ruler measurement tool" aria-pressed="false">
                    <span class="icon">üìè</span>
                    <span class="btn-text hidden sm:inline">Ruler</span>
                </button>
                <div class="relative">
                    <button id="tool-fog" class="btn-tool" title="Fog of War" aria-label="Fog of war tool" aria-pressed="false">
                        <span class="icon">üëÅÔ∏è</span>
                        <span class="btn-text hidden sm:inline">Fog</span>
                    </button>
                    <div id="fog-submenu" class="hidden absolute top-full left-0 mt-1 bg-gray-800 border border-gray-600 rounded shadow-lg z-50 min-w-32">
                        <button class="btn-secondary w-full active" data-fog-mode="brush" aria-label="Fog brush mode">
                            <span>üñåÔ∏è</span> Brush
                        </button>
                        <button class="btn-secondary w-full" data-fog-mode="cone" aria-label="Fog cone mode">
                            <span>üìê</span> Cone
                        </button>
                        <button class="btn-secondary w-full" data-fog-mode="circle" aria-label="Fog circle mode">
                            <span>‚≠ï</span> Circle
                        </button>
                        <button class="btn-secondary w-full" data-fog-mode="clear" aria-label="Clear fog mode">
                            <span>üßπ</span> Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center gap-4">
                <!-- Zoom Controls -->
                <div class="flex items-center gap-2">
                    <button id="zoom-out" class="btn-icon" title="Zoom Out" aria-label="Zoom out">
                        <span class="icon">üîç‚ûñ</span>
                    </button>
                    <button id="zoom-in" class="btn-icon" title="Zoom In" aria-label="Zoom in">
                        <span class="icon">üîç‚ûï</span>
                    </button>
                </div>
                
                <!-- Grid Toggle -->
                <button id="grid-toggle" class="btn-secondary" title="Toggle Grid" aria-label="Toggle grid overlay" aria-pressed="true">
                    <span class="icon">#Ô∏è‚É£</span>
                    <span>Grid</span>
                </button>
                
                <!-- Upload Button -->
                <button id="upload-campaign" class="btn-icon" title="Upload D&D Beyond Campaign" aria-label="Upload campaign files">
                    <span class="icon">üìÇ</span>
                </button>
                
                <!-- Upload Expansion Button -->
                <button id="upload-expansion" class="btn-icon" title="Upload Expansion" aria-label="Upload expansion content">
                    <span class="icon">üì¶</span>
                </button>
                
                <!-- Unified Control Center Toggle -->
                <button id="control-center-toggle" class="btn-primary" title="Toggle Control Center" aria-label="Toggle unified control center">
                    <span class="icon">üéõÔ∏è</span>
                    <span>Controls</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 relative flex">
            <!-- Left Sidebar Panel - HIDDEN for modular system -->
            <div id="sidebar-panel" class="hidden w-80 bg-gray-900 border-r border-gray-700 flex flex-col">
                <!-- Panel Tabs -->
                <div class="flex bg-gray-800 border-b border-gray-700" role="tablist" aria-label="Panel navigation">
                    <button class="btn-tab active" data-panel="party" role="tab" aria-selected="true" aria-controls="panel-content" aria-label="Party management tab">
                        <span class="icon">üë•</span> Party
                    </button>
                    <button class="btn-tab" data-panel="initiative" role="tab" aria-selected="false" aria-controls="panel-content" aria-label="Initiative tracker tab">
                        <span class="icon">‚ö°</span> Initiative
                    </button>
                    <button class="btn-tab" data-panel="tokens" role="tab" aria-selected="false" aria-controls="panel-content" aria-label="Token maker tab">
                        <span class="icon">üé®</span> Tokens
                    </button>
                    <button class="btn-tab" data-panel="maps" role="tab" aria-selected="false" aria-controls="panel-content" aria-label="Maps management tab">
                        <span class="icon">üó∫Ô∏è</span> Maps
                    </button>
                </div>
                
                <!-- Panel Content -->
                <div class="flex-1 overflow-y-auto">
                    <div id="panel-content" class="p-4">
                        <!-- Panel content will be dynamically populated -->
                    </div>
                </div>
            </div>
            
            <!-- Battle Map Canvas -->
            <div class="flex-1 h-full relative overflow-hidden">
                <canvas 
                    id="battle-canvas" 
                    class="battle-canvas w-full h-full grid-overlay"
                    width="1200" 
                    height="800"
                ></canvas>
                
                <!-- Canvas Overlay for UI Elements -->
                <div id="canvas-overlay" class="absolute inset-0 pointer-events-none">
                    <!-- Ruler display -->
                    <div id="ruler-display" class="hidden absolute bg-black bg-opacity-75 text-white px-2 py-1 rounded text-xs"></div>
                </div>
                
                <!-- Unified Floating Control Center -->
                <div id="control-center" class="control-center absolute bg-gray-900 border border-gray-700 rounded-lg shadow-lg hidden">
                    <!-- Control Center Header (draggable) -->
                    <div id="control-center-header" class="control-center-header bg-gray-800 px-4 py-2 rounded-t-lg cursor-move border-b border-gray-700 relative">
                        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                            <span class="icon w-5 h-5">üéõÔ∏è</span>
                            Module Control Center
                        </h3>
                        <!-- Close Button -->
                        <button id="control-center-close" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-red-600 hover:bg-red-700 text-white rounded flex items-center justify-center text-sm transition-colors" title="Close control center" aria-label="Close control center">
                            <span>√ó</span>
                        </button>
                    </div>
                    
                    <!-- Module Control Buttons -->
                    <div class="control-center-content p-4">
                        <h4 class="text-lg font-semibold text-green-400 mb-4">Available Modules</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="module-toggle-btn" data-module="party">
                                <span class="icon">üë•</span>
                                <span class="label">Party</span>
                            </button>
                            <button class="module-toggle-btn" data-module="initiative">
                                <span class="icon">‚ö°</span>
                                <span class="label">Initiative</span>
                            </button>
                            <button class="module-toggle-btn" data-module="tokens">
                                <span class="icon">üé®</span>
                                <span class="label">Tokens</span>
                            </button>
                            <button class="module-toggle-btn" data-module="maps">
                                <span class="icon">üó∫Ô∏è</span>
                                <span class="label">Maps</span>
                            </button>
                            <button class="module-toggle-btn" data-module="tools">
                                <span class="icon">üõ†Ô∏è</span>
                                <span class="label">Tools</span>
                            </button>
                            <button class="module-toggle-btn" data-module="chat">
                                <span class="icon">üí¨</span>
                                <span class="label">Chat</span>
                            </button>
                            <button class="module-toggle-btn" data-module="dice">
                                <span class="icon">üé≤</span>
                                <span class="label">Dice</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resize Handles -->
                    <div class="resize-handle resize-handle-n" data-direction="n"></div>
                    <div class="resize-handle resize-handle-s" data-direction="s"></div>
                    <div class="resize-handle resize-handle-e" data-direction="e"></div>
                    <div class="resize-handle resize-handle-w" data-direction="w"></div>
                    <div class="resize-handle resize-handle-ne" data-direction="ne"></div>
                    <div class="resize-handle resize-handle-nw" data-direction="nw"></div>
                    <div class="resize-handle resize-handle-se" data-direction="se"></div>
                    <div class="resize-handle resize-handle-sw" data-direction="sw"></div>
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="bg-gray-900 border-t border-gray-700 px-4 py-2 flex items-center justify-between text-sm text-gray-400">
            <div class="flex items-center gap-4">
                <span>Tool: <span id="current-tool" class="text-green-400">Move</span></span>
                <span>Grid: <span id="grid-status" class="text-green-400">On</span></span>
            </div>
            <div class="flex items-center gap-4">
                <span>Tokens: <span id="token-count" class="text-yellow-400">0</span></span>
                <span>Canvas: <span id="canvas-size" class="text-blue-400">1200x800</span></span>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center">
        <div class="modal-content bg-gray-900 rounded-lg shadow-lg p-6 w-full max-w-2xl mx-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Upload Files</h2>
                <button id="close-upload-modal" class="btn-icon text-2xl" aria-label="Close upload dialog">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Background Map Images -->
                <div>
                    <h3 class="text-lg text-green-400 mb-2">Background Map Images</h3>
                    <div id="image-drop-area" class="drag-drop-area rounded-lg p-8 text-center">
                        <div class="text-gray-300 mb-2">
                            <span class="text-4xl">üó∫Ô∏è</span>
                        </div>
                        <p class="text-white mb-2">Drag & drop map images here</p>
                        <p class="text-gray-400 text-sm">PNG, JPG, JPEG, GIF, WebP files ‚Ä¢ or click to browse</p>
                        <input type="file" id="image-file-input" class="hidden" accept=".png,.jpg,.jpeg,.gif,.webp" multiple>
                    </div>
                    <div id="current-background" class="mt-2 text-sm text-gray-400 hidden">
                        Current: <span id="current-background-name">None</span>
                        <button id="clear-background" class="ml-2 text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                
                <!-- Campaign File Upload -->
                <div>
                    <h3 class="text-lg text-green-400 mb-2">Campaign Files</h3>
                    <div id="campaign-drop-area" class="drag-drop-area rounded-lg p-8 text-center">
                        <div class="text-gray-300 mb-2">
                            <span class="text-4xl">üìÅ</span>
                        </div>
                        <p class="text-white mb-2">Drag & drop D&D Beyond campaign files here</p>
                        <p class="text-gray-400 text-sm">or click to browse</p>
                        <input type="file" id="campaign-file-input" class="hidden" accept=".json,.xml,.zip" multiple>
                    </div>
                </div>
                
                <!-- PDF Upload for Enemies -->
                <div>
                    <h3 class="text-lg text-green-400 mb-2">Enemy PDFs</h3>
                    <div id="pdf-drop-area" class="drag-drop-area rounded-lg p-8 text-center">
                        <div class="text-gray-300 mb-2">
                            <span class="text-4xl">üìÑ</span>
                        </div>
                        <p class="text-white mb-2">Drag & drop enemy PDF files here</p>
                        <p class="text-gray-400 text-sm">or click to browse</p>
                        <input type="file" id="pdf-file-input" class="hidden" accept=".pdf" multiple>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="upload-progress" class="hidden">
                    <div class="text-sm text-gray-300 mb-2">Uploading...</div>
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="upload-progress-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Sheet Modal -->
    <div id="character-sheet-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center">
        <div class="modal-content character-sheet rounded-lg shadow-lg w-full max-w-6xl mx-4 h-5/6">
            <div class="flex flex-col h-full">
                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-700">
                    <div class="flex items-center gap-4">
                        <h2 id="character-name" class="text-2xl font-bold text-white">Character Name</h2>
                        <span id="character-level" class="text-green-400">Level 1</span>
                        <span id="character-class" class="text-yellow-400">Class</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="expand-character-sheet" class="btn-secondary text-sm" aria-label="Expand character sheet to full view">
                            Expand to Full View
                        </button>
                        <button id="close-character-sheet" class="btn-icon text-2xl" aria-label="Close character sheet">&times;</button>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="character-sheet-tabs flex overflow-x-auto" role="tablist" aria-label="Character sheet sections">
                    <button class="btn-tab active whitespace-nowrap" data-tab="overview" role="tab" aria-selected="true" aria-label="Character overview tab">Overview</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="actions" role="tab" aria-selected="false" aria-label="Character actions tab">Actions</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="spells" role="tab" aria-selected="false" aria-label="Character spells tab">Spells</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="inventory" role="tab" aria-selected="false" aria-label="Character inventory tab">Inventory</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="features" role="tab" aria-selected="false" aria-label="Character features tab">Features</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="description" role="tab" aria-selected="false" aria-label="Character description tab">Description</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="notes" role="tab" aria-selected="false" aria-label="Character notes tab">Notes</button>
                    <button class="btn-tab whitespace-nowrap" data-tab="extras" role="tab" aria-selected="false" aria-label="Character extras tab">Extras</button>
                </div>
                
                <!-- Tab Content -->
                <div class="flex-1 p-4 overflow-y-auto">
                    <div id="tab-content" class="h-full">
                        <!-- Tab content will be dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-viewer-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center">
        <div class="modal-content bg-gray-900 rounded-lg shadow-lg w-full max-w-4xl mx-4 h-5/6">
            <div class="flex flex-col h-full">
                <div class="flex items-center justify-between p-4 border-b border-gray-700">
                    <h2 id="pdf-title" class="text-xl font-bold text-white">Enemy Information</h2>
                    <button id="close-pdf-viewer" class="btn-icon text-2xl" aria-label="Close PDF viewer">&times;</button>
                </div>
                <div class="flex-1 p-4">
                    <iframe id="pdf-iframe" class="w-full h-full border-0 rounded" src=""></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Creation Modal -->
    <div id="map-creation-modal" class="fixed inset-0 modal-overlay hidden flex items-center justify-center">
        <div class="modal-content bg-gray-900 rounded-lg shadow-lg p-6 w-full max-w-2xl mx-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Create New Map</h2>
                <button id="close-map-creation-modal" class="btn-icon text-2xl" aria-label="Close map creation dialog">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Map Name -->
                <div>
                    <label for="map-name-input" class="block text-sm font-medium text-gray-300 mb-2">Map Name</label>
                    <input type="text" id="map-name-input" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter map name">
                </div>
                
                <!-- Image Selection Options -->
                <div>
                    <h3 class="text-lg text-green-400 mb-3">Background Image (Optional)</h3>
                    
                    <!-- Option Tabs -->
                    <div class="flex border-b border-gray-700 mb-4">
                        <button id="upload-new-tab" class="tab-button active px-4 py-2 text-sm font-medium text-green-400 border-b-2 border-green-400">Upload New</button>
                        <button id="select-existing-tab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">Select Existing</button>
                    </div>
                    
                    <!-- Upload New Image Tab -->
                    <div id="upload-new-content" class="tab-content">
                        <div id="map-image-drop-area" class="drag-drop-area rounded-lg p-8 text-center border-2 border-dashed border-gray-600 hover:border-green-500 transition-colors cursor-pointer">
                            <div class="text-gray-300 mb-2">
                                <span class="text-4xl">üó∫Ô∏è</span>
                            </div>
                            <p class="text-white mb-2">Drag & drop map image here</p>
                            <p class="text-gray-400 text-sm">PNG, JPG, JPEG, GIF, WebP files ‚Ä¢ or click to browse</p>
                            <input type="file" id="map-image-file-input" class="hidden" accept=".png,.jpg,.jpeg,.gif,.webp">
                        </div>
                        <div id="upload-preview" class="mt-3 hidden">
                            <div class="text-sm text-gray-300 mb-2">Selected Image:</div>
                            <div class="flex items-center bg-gray-800 rounded p-3">
                                <img id="upload-preview-img" class="w-16 h-16 object-cover rounded mr-3" src="" alt="Preview">
                                <div class="flex-1">
                                    <div id="upload-preview-name" class="text-white font-medium"></div>
                                    <div class="text-xs text-gray-400">New upload</div>
                                </div>
                                <button id="clear-upload-preview" class="text-red-400 hover:text-red-300 text-sm">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Select Existing Image Tab -->
                    <div id="select-existing-content" class="tab-content hidden">
                        <div id="image-gallery" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Image gallery will be populated dynamically -->
                        </div>
                        <div id="no-images-message" class="text-center text-gray-400 py-8 hidden">
                            <span class="text-2xl">üìÅ</span>
                            <p class="mt-2">No images uploaded yet</p>
                            <p class="text-sm">Upload images first using the main upload button or the "Upload New" tab</p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-700">
                    <button id="cancel-map-creation" class="btn-secondary">Cancel</button>
                    <button id="create-map-confirm" class="btn-primary">Create Map</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergent Badge -->
    <a
        id="emergent-badge"
        target="_blank"
        href="https://app.emergent.sh/?utm_source=emergent-badge"
        style="
            display: flex !important;
            align-items: center !important;
            position: fixed !important;
            bottom: 20px;
            right: 20px;
            text-decoration: none;
            padding: 6px 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif !important;
            font-size: 12px !important;
            z-index: 9999 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            border-radius: 8px !important;
            background-color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.25) !important;
        "
    >
        <div style="display: flex; flex-direction: row; align-items: center">
            <span style="width: 20px; height: 20px; margin-right: 8px; font-size: 16px;">‚ö°</span>
            <p style="color: #000000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif !important; font-size: 12px !important; align-items: center; margin-bottom: 0;">
                Made with Emergent
            </p>
        </div>
    </a>

    <script>
        // Battle Map Application State
        const appState = {
            currentTool: 'move',
            currentPanel: 'party',
            fogMode: 'brush',
            zoom: 1.0,
            gridEnabled: true,
            camera: { x: 0, y: 0 },
            tokens: [],
            isDragging: false,
            dragStart: { x: 0, y: 0 },
            selectedToken: null,
            backgroundImage: null,
            backgroundImageName: null,
            currentMapId: 'main',
            maps: {
                main: {
                    id: 'main',
                    name: 'Main Map',
                    backgroundImage: null,
                    backgroundImageName: null,
                    tokens: [],
                    camera: { x: 0, y: 0 },
                    zoom: 1.0,
                    fogOfWar: []
                }
            },
            uploadedFiles: {
                campaigns: [],
                pdfs: [],
                images: []
            },
            characterSheets: new Map(),
            enemyPdfs: new Map(),
            party: [],
            initiative: [],
            fogOfWar: []
        };
        
        // Get canvas and context
        const canvas = document.getElementById('battle-canvas');
        const ctx = canvas.getContext('2d');
        
        // Resize canvas to fit container
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            redrawCanvas();
        }
        
        // Tool selection
        document.querySelectorAll('.btn-tool').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tools
                document.querySelectorAll('.btn-tool').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-pressed', 'false');
                });
                
                // Add active class to clicked tool
                button.classList.add('active');
                button.setAttribute('aria-pressed', 'true');
                
                // Update current tool
                const toolId = button.id.replace('tool-', '');
                appState.currentTool = toolId;
                document.getElementById('current-tool').textContent = toolId.charAt(0).toUpperCase() + toolId.slice(1);
                
                // Show fog submenu if fog tool selected
                if (toolId === 'fog') {
                    document.getElementById('fog-submenu').classList.remove('hidden');
                } else {
                    document.getElementById('fog-submenu').classList.add('hidden');
                }
                
                // Update cursor
                canvas.className = `battle-canvas w-full h-full ${appState.gridEnabled ? 'grid-overlay' : ''}`;
                if (toolId === 'move') {
                    canvas.style.cursor = 'grab';
                } else if (toolId === 'ruler') {
                    canvas.style.cursor = 'crosshair';
                } else if (toolId === 'fog') {
                    canvas.style.cursor = getFogCursor();
                } else {
                    canvas.style.cursor = 'pointer';
                }
            });
        });
        
        // Fog mode selection
        document.addEventListener('click', (e) => {
            const fogModeBtn = e.target.closest('[data-fog-mode]');
            if (fogModeBtn) {
                // Update active fog mode
                document.querySelectorAll('[data-fog-mode]').forEach(btn => {
                    btn.classList.remove('active');
                });
                fogModeBtn.classList.add('active');
                
                appState.fogMode = fogModeBtn.dataset.fogMode;
                canvas.style.cursor = getFogCursor();
                
                addChatMessage(`Fog mode: ${appState.fogMode}`, 'system');
            } else if (!e.target.closest('#fog-submenu') && !e.target.closest('#tool-fog')) {
                // Hide fog submenu when clicking outside
                document.getElementById('fog-submenu').classList.add('hidden');
            }
        });
        
        function getFogCursor() {
            switch (appState.fogMode) {
                case 'brush':
                    return 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'currentColor\' stroke-width=\'2\'%3E%3Cpath d=\'M9 9a3 3 0 1 1 6 0\'/%3E%3Cpath d=\'M6 8a6 6 0 0 1 12 0c0 7-3 9-6 9s-6-2-6-9\'/%3E%3C/svg%3E") 12 12, auto';
                case 'cone':
                    return 'crosshair';
                case 'circle':
                    return 'crosshair';
                case 'clear':
                    return 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'currentColor\' stroke-width=\'2\'%3E%3Cpath d=\'M3 6h18\'/%3E%3Cpath d=\'M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\'/%3E%3Cpath d=\'M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\'/%3E%3C/svg%3E") 12 12, auto';
                default:
                    return 'crosshair';
            }
        }
        
        // Panel tab selection
        document.querySelectorAll('.btn-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelName = tab.dataset.panel;
                if (panelName) {
                    showPanel(panelName);
                }
            });
        });
        
        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            appState.zoom = Math.min(appState.zoom * 1.2, 5.0);
            updateZoomDisplay();
            redrawCanvas();
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            appState.zoom = Math.max(appState.zoom / 1.2, 0.1);
            updateZoomDisplay();
            redrawCanvas();
        });
        
        function updateZoomDisplay() {
            document.getElementById('zoom-badge').textContent = Math.round(appState.zoom * 100) + '%';
        }
        
        // Grid toggle
        document.getElementById('grid-toggle').addEventListener('click', () => {
            appState.gridEnabled = !appState.gridEnabled;
            document.getElementById('grid-status').textContent = appState.gridEnabled ? 'On' : 'Off';
            canvas.classList.toggle('grid-overlay', appState.gridEnabled);
        });
        
        // Canvas mouse events
        canvas.addEventListener('mousedown', (e) => {
            if (appState.currentTool === 'move') {
                appState.isDragging = true;
                appState.dragStart = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
            } else if (appState.currentTool === 'token') {
                // Check if clicking on existing token first
                const clickX = (e.offsetX - appState.camera.x) / appState.zoom;
                const clickY = (e.offsetY - appState.camera.y) / appState.zoom;
                
                const clickedToken = appState.tokens.find(t => {
                    const distance = Math.sqrt(Math.pow(clickX - t.x, 2) + Math.pow(clickY - t.y, 2));
                    return distance <= t.size;
                });
                
                if (clickedToken) {
                    selectToken(e.offsetX, e.offsetY);
                } else {
                    addToken(e.offsetX, e.offsetY);
                }
            }
        });
        
        canvas.addEventListener('click', (e) => {
            if (appState.currentTool === 'move') {
                // Select token on click when in move mode
                selectToken(e.offsetX, e.offsetY);
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (appState.isDragging && appState.currentTool === 'move') {
                const dx = e.clientX - appState.dragStart.x;
                const dy = e.clientY - appState.dragStart.y;
                appState.camera.x += dx;
                appState.camera.y += dy;
                appState.dragStart = { x: e.clientX, y: e.clientY };
                redrawCanvas();
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            if (appState.isDragging) {
                appState.isDragging = false;
                canvas.style.cursor = 'grab';
            }
        });
        
        // Add token function
        function addToken(x, y) {
            const token = {
                id: Date.now(),
                x: x - appState.camera.x,
                y: y - appState.camera.y,
                color: ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'][Math.floor(Math.random() * 5)],
                size: 20,
                type: 'player', // 'player' or 'enemy'
                name: 'New Token',
                characterSheet: createDefaultCharacterSheet(),
                pdfUrl: null
            };
            appState.tokens.push(token);
            document.getElementById('token-count').textContent = appState.tokens.length;
            redrawCanvas();
        }
        
        // Create default character sheet structure
        function createDefaultCharacterSheet() {
            return {
                name: 'New Character',
                level: 1,
                class: 'Fighter',
                race: 'Human',
                background: 'Soldier',
                stats: {
                    str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10
                },
                health: {
                    current: 10,
                    max: 10,
                    temp: 0
                },
                ac: 10,
                speed: 30,
                initiative: 0,
                proficiencyBonus: 2,
                savingThrows: {
                    str: false, dex: false, con: false, int: false, wis: false, cha: false
                },
                skills: {
                    acrobatics: 0, animalHandling: 0, arcana: 0, athletics: 0,
                    deception: 0, history: 0, insight: 0, intimidation: 0,
                    investigation: 0, medicine: 0, nature: 0, perception: 0,
                    performance: 0, persuasion: 0, religion: 0, sleightOfHand: 0,
                    stealth: 0, survival: 0
                },
                spells: [],
                inventory: [],
                features: [],
                notes: ''
            };
        }
        
        // Token selection
        function selectToken(x, y) {
            const clickX = (x - appState.camera.x) / appState.zoom;
            const clickY = (y - appState.camera.y) / appState.zoom;
            
            // Find clicked token
            const token = appState.tokens.find(t => {
                const distance = Math.sqrt(Math.pow(clickX - t.x, 2) + Math.pow(clickY - t.y, 2));
                return distance <= t.size;
            });
            
            if (token) {
                appState.selectedToken = token;
                showCharacterSheet(token);
                redrawCanvas();
            } else {
                appState.selectedToken = null;
                redrawCanvas();
            }
        }
        
        // Draw canvas
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Save context for transformations
            ctx.save();
            
            // Apply camera transformation
            ctx.translate(appState.camera.x, appState.camera.y);
            ctx.scale(appState.zoom, appState.zoom);
            
            // Draw background image if present
            if (appState.backgroundImage) {
                // Calculate centered position and scaling to fit canvas
                const imageAspect = appState.backgroundImage.width / appState.backgroundImage.height;
                const canvasAspect = canvas.width / canvas.height;
                
                let drawWidth, drawHeight, drawX, drawY;
                
                // Scale to fit canvas while maintaining aspect ratio
                if (imageAspect > canvasAspect) {
                    // Image is wider than canvas ratio
                    drawWidth = canvas.width / appState.zoom;
                    drawHeight = drawWidth / imageAspect;
                } else {
                    // Image is taller than canvas ratio
                    drawHeight = canvas.height / appState.zoom;
                    drawWidth = drawHeight * imageAspect;
                }
                
                // Center the image
                drawX = -appState.camera.x / appState.zoom + (canvas.width / appState.zoom - drawWidth) / 2;
                drawY = -appState.camera.y / appState.zoom + (canvas.height / appState.zoom - drawHeight) / 2;
                
                ctx.drawImage(appState.backgroundImage, drawX, drawY, drawWidth, drawHeight);
            }
            
            // Draw tokens
            appState.tokens.forEach(token => {
                ctx.beginPath();
                ctx.arc(token.x, token.y, token.size, 0, 2 * Math.PI);
                ctx.fillStyle = token.color;
                ctx.fill();
                
                // Token border
                ctx.strokeStyle = appState.selectedToken === token ? '#fbbf24' : '#ffffff';
                ctx.lineWidth = appState.selectedToken === token ? 4 : 2;
                ctx.stroke();
                
                // Selection glow
                if (appState.selectedToken === token) {
                    ctx.beginPath();
                    ctx.arc(token.x, token.y, token.size + 6, 0, 2 * Math.PI);
                    ctx.strokeStyle = '#fbbf24';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.6;
                    ctx.stroke();
                    ctx.globalAlpha = 1.0;
                }
                
                // Token border glow
                ctx.beginPath();
                ctx.arc(token.x, token.y, token.size + 2, 0, 2 * Math.PI);
                ctx.strokeStyle = token.color;
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.3;
                ctx.stroke();
                ctx.globalAlpha = 1.0;
                
                // Token name
                if (token.name) {
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(token.name, token.x, token.y + token.size + 15);
                }
            });
            
            // Restore context
            ctx.restore();
        }
        
        // Character Sheet Functions
        function showCharacterSheet(token) {
            const modal = document.getElementById('character-sheet-modal');
            const sheet = token.characterSheet;
            
            // Update header
            document.getElementById('character-name').textContent = sheet.name;
            document.getElementById('character-level').textContent = `Level ${sheet.level}`;
            document.getElementById('character-class').textContent = sheet.class;
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Load overview tab by default
            showCharacterTab('overview', sheet);
        }
        
        function showCharacterTab(tabName, sheet) {
            // Update active tab
            document.querySelectorAll('.character-sheet-tabs .btn-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');
            }
            
            // Generate tab content
            const content = document.getElementById('tab-content');
            content.innerHTML = generateTabContent(tabName, sheet);
        }
        
        function generateTabContent(tabName, sheet) {
            switch (tabName) {
                case 'overview':
                    return generateOverviewTab(sheet);
                case 'actions':
                    return generateActionsTab(sheet);
                case 'spells':
                    return generateSpellsTab(sheet);
                case 'inventory':
                    return generateInventoryTab(sheet);
                case 'features':
                    return generateFeaturesTab(sheet);
                case 'description':
                    return generateDescriptionTab(sheet);
                case 'notes':
                    return generateNotesTab(sheet);
                case 'extras':
                    return generateExtrasTab(sheet);
                default:
                    return '<div class="text-white">Tab content not implemented yet.</div>';
            }
        }
        
        function generateOverviewTab(sheet) {
            const getModifier = (score) => Math.floor((score - 10) / 2);
            const formatModifier = (mod) => mod >= 0 ? `+${mod}` : `${mod}`;
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Health -->
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Health</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white">${sheet.health.current}</div>
                                <div class="text-xs text-gray-400">Current HP</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white">${sheet.health.max}</div>
                                <div class="text-xs text-gray-400">Max HP</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400">${sheet.health.temp}</div>
                                <div class="text-xs text-gray-400">Temp HP</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Core Stats -->
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Ability Scores</h3>
                        <div class="grid grid-cols-3 gap-2">
                            ${Object.entries(sheet.stats).map(([stat, score]) => `
                                <div class="text-center bg-gray-700 rounded p-2">
                                    <div class="text-xs text-gray-400 uppercase">${stat}</div>
                                    <div class="text-lg font-bold text-white">${score}</div>
                                    <div class="text-sm text-yellow-400">${formatModifier(getModifier(score))}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Combat Stats -->
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Combat</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.ac}</div>
                                <div class="text-xs text-gray-400">Armor Class</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${formatModifier(sheet.initiative)}</div>
                                <div class="text-xs text-gray-400">Initiative</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.speed} ft</div>
                                <div class="text-xs text-gray-400">Speed</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Character Info -->
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Character Info</h3>
                        <div class="space-y-2">
                            <div><span class="text-gray-400">Race:</span> <span class="text-white">${sheet.race}</span></div>
                            <div><span class="text-gray-400">Class:</span> <span class="text-white">${sheet.class}</span></div>
                            <div><span class="text-gray-400">Level:</span> <span class="text-white">${sheet.level}</span></div>
                            <div><span class="text-gray-400">Background:</span> <span class="text-white">${sheet.background}</span></div>
                            <div><span class="text-gray-400">Proficiency Bonus:</span> <span class="text-white">+${sheet.proficiencyBonus}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateActionsTab(sheet) {
            const getModifier = (score) => Math.floor((score - 10) / 2);
            const formatModifier = (mod) => mod >= 0 ? `+${mod}` : `${mod}`;
            
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Combat Stats</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.ac || 10}</div>
                                <div class="text-sm text-gray-300">Armor Class</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${formatModifier(sheet.initiative || 0)}</div>
                                <div class="text-sm text-gray-300">Initiative</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.speed || 30} ft</div>
                                <div class="text-sm text-gray-300">Speed</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Saving Throws</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Strength</span>
                                <span class="text-gray-300">${formatModifier(getModifier(sheet.stats.str) + (sheet.savingThrows?.str ? sheet.proficiencyBonus : 0))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Dexterity</span>
                                <span class="text-gray-300">${formatModifier(getModifier(sheet.stats.dex) + (sheet.savingThrows?.dex ? sheet.proficiencyBonus : 0))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Constitution</span>
                                <span class="text-gray-300">${formatModifier(getModifier(sheet.stats.con) + (sheet.savingThrows?.con ? sheet.proficiencyBonus : 0))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Intelligence</span>
                                <span class="text-gray-300">${formatModifier(getModifier(sheet.stats.int) + (sheet.savingThrows?.int ? sheet.proficiencyBonus : 0))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Wisdom</span>
                                <span class="text-gray-300">${formatModifier(getModifier(sheet.stats.wis) + (sheet.savingThrows?.wis ? sheet.proficiencyBonus : 0))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Charisma</span>
                                <span class="text-gray-300">${formatModifier(getModifier(sheet.stats.cha) + (sheet.savingThrows?.cha ? sheet.proficiencyBonus : 0))}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Standard Actions</h3>
                        <div class="space-y-2">
                            <div class="bg-gray-700 rounded p-3">
                                <div class="font-semibold text-white">Attack</div>
                                <div class="text-sm text-gray-300">Make a weapon attack roll</div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="font-semibold text-white">Dash</div>
                                <div class="text-sm text-gray-300">Double your speed for the turn</div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="font-semibold text-white">Dodge</div>
                                <div class="text-sm text-gray-300">Focus entirely on avoiding attacks</div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="font-semibold text-white">Help</div>
                                <div class="text-sm text-gray-300">Aid an ally with their next action</div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="font-semibold text-white">Hide</div>
                                <div class="text-sm text-gray-300">Make a Stealth check to hide</div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="font-semibold text-white">Search</div>
                                <div class="text-sm text-gray-300">Make a Perception or Investigation check</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateSpellsTab(sheet) {
            const getModifier = (score) => Math.floor((score - 10) / 2);
            const formatModifier = (mod) => mod >= 0 ? `+${mod}` : `${mod}`;
            
            // Display spells if available
            const spellsContent = sheet.spells && sheet.spells.length > 0 
                ? sheet.spells.map(spell => `
                    <div class="bg-gray-700 rounded p-3">
                        <div class="font-semibold text-white">${spell.name}</div>
                        <div class="text-sm text-gray-300">Level ${spell.level} ${spell.school}</div>
                        ${spell.description ? `<div class="text-xs text-gray-400 mt-1">${spell.description}</div>` : ''}
                    </div>
                `).join('')
                : '<div class="text-gray-300">No spells available</div>';
            
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Skills</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Acrobatics (Dex)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.acrobatics || getModifier(sheet.stats.dex))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Animal Handling (Wis)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.animalHandling || getModifier(sheet.stats.wis))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Arcana (Int)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.arcana || getModifier(sheet.stats.int))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Athletics (Str)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.athletics || getModifier(sheet.stats.str))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Deception (Cha)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.deception || getModifier(sheet.stats.cha))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">History (Int)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.history || getModifier(sheet.stats.int))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Insight (Wis)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.insight || getModifier(sheet.stats.wis))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Intimidation (Cha)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.intimidation || getModifier(sheet.stats.cha))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Investigation (Int)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.investigation || getModifier(sheet.stats.int))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Medicine (Wis)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.medicine || getModifier(sheet.stats.wis))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Nature (Int)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.nature || getModifier(sheet.stats.int))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Perception (Wis)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.perception || getModifier(sheet.stats.wis))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Performance (Cha)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.performance || getModifier(sheet.stats.cha))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Persuasion (Cha)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.persuasion || getModifier(sheet.stats.cha))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Religion (Int)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.religion || getModifier(sheet.stats.int))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Sleight of Hand (Dex)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.sleightOfHand || getModifier(sheet.stats.dex))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Stealth (Dex)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.stealth || getModifier(sheet.stats.dex))}</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700 rounded">
                                <span class="text-white">Survival (Wis)</span>
                                <span class="text-gray-300">${formatModifier(sheet.skills?.survival || getModifier(sheet.stats.wis))}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Spells</h3>
                        <div class="space-y-2">
                            ${spellsContent}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateInventoryTab(sheet) {
            // Display inventory items if available
            const inventoryContent = sheet.inventory && sheet.inventory.length > 0 
                ? sheet.inventory.map(item => `
                    <div class="bg-gray-700 rounded p-3">
                        <div class="flex justify-between">
                            <div class="font-semibold text-white">${item.name}</div>
                            ${item.quantity ? `<div class="text-gray-300">${item.quantity}</div>` : ''}
                        </div>
                        ${item.type ? `<div class="text-sm text-gray-400">${item.type}</div>` : ''}
                        ${item.description ? `<div class="text-xs text-gray-400 mt-1">${item.description}</div>` : ''}
                        ${item.weight ? `<div class="text-xs text-gray-500">Weight: ${item.weight} lbs</div>` : ''}
                    </div>
                `).join('')
                : '<div class="text-gray-300">No items in inventory</div>';
            
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Equipment Overview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.ac || 10}</div>
                                <div class="text-sm text-gray-300">Armor Class</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.proficiencyBonus || 2}</div>
                                <div class="text-sm text-gray-300">Proficiency</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-white">${sheet.inventory?.length || 0}</div>
                                <div class="text-sm text-gray-300">Items</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Inventory</h3>
                        <div class="space-y-2">
                            ${inventoryContent}
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Currency</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                            <div class="text-center p-2 bg-gray-700 rounded">
                                <div class="font-semibold text-yellow-400">${sheet.currency?.cp || 0}</div>
                                <div class="text-gray-300">CP</div>
                            </div>
                            <div class="text-center p-2 bg-gray-700 rounded">
                                <div class="font-semibold text-gray-400">${sheet.currency?.sp || 0}</div>
                                <div class="text-gray-300">SP</div>
                            </div>
                            <div class="text-center p-2 bg-gray-700 rounded">
                                <div class="font-semibold text-yellow-600">${sheet.currency?.ep || 0}</div>
                                <div class="text-gray-300">EP</div>
                            </div>
                            <div class="text-center p-2 bg-gray-700 rounded">
                                <div class="font-semibold text-yellow-500">${sheet.currency?.gp || 0}</div>
                                <div class="text-gray-300">GP</div>
                            </div>
                            <div class="text-center p-2 bg-gray-700 rounded">
                                <div class="font-semibold text-white">${sheet.currency?.pp || 0}</div>
                                <div class="text-gray-300">PP</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateFeaturesTab(sheet) {
            // Display features if available
            const featuresContent = sheet.features && sheet.features.length > 0 
                ? sheet.features.map(feature => `
                    <div class="bg-gray-700 rounded p-3">
                        <div class="font-semibold text-white">${feature.name}</div>
                        ${feature.source ? `<div class="text-sm text-gray-400">${feature.source}</div>` : ''}
                        ${feature.description ? `<div class="text-sm text-gray-300 mt-1">${feature.description}</div>` : ''}
                        ${feature.uses ? `<div class="text-xs text-gray-400 mt-1">Uses: ${feature.uses}</div>` : ''}
                    </div>
                `).join('')
                : '<div class="text-gray-300">No features configured</div>';
            
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Character Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-400">Race</div>
                                <div class="text-white font-semibold">${sheet.race || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Class</div>
                                <div class="text-white font-semibold">${sheet.class || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Level</div>
                                <div class="text-white font-semibold">${sheet.level || 1}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Background</div>
                                <div class="text-white font-semibold">${sheet.background || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Proficiency Bonus</div>
                                <div class="text-white font-semibold">+${sheet.proficiencyBonus || 2}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Experience Points</div>
                                <div class="text-white font-semibold">${sheet.experience || 0}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Features & Traits</h3>
                        <div class="space-y-2">
                            ${featuresContent}
                        </div>
                    </div>
                    
                    ${sheet.classFeatures ? `
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Class Features</h3>
                        <div class="space-y-2">
                            ${sheet.classFeatures.map(feature => `
                                <div class="bg-gray-700 rounded p-3">
                                    <div class="font-semibold text-white">${feature.name}</div>
                                    <div class="text-sm text-gray-400">Level ${feature.level}</div>
                                    ${feature.description ? `<div class="text-sm text-gray-300 mt-1">${feature.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function generateDescriptionTab(sheet) {
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Physical Description</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-400">Age</div>
                                <div class="text-white">${sheet.description?.age || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Height</div>
                                <div class="text-white">${sheet.description?.height || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Weight</div>
                                <div class="text-white">${sheet.description?.weight || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Eyes</div>
                                <div class="text-white">${sheet.description?.eyes || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Hair</div>
                                <div class="text-white">${sheet.description?.hair || 'Unknown'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Skin</div>
                                <div class="text-white">${sheet.description?.skin || 'Unknown'}</div>
                            </div>
                        </div>
                        ${sheet.description?.appearance ? `
                        <div class="mt-4">
                            <div class="text-sm text-gray-400">Appearance</div>
                            <div class="text-white text-sm mt-1">${sheet.description.appearance}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Personality</h3>
                        <div class="space-y-4">
                            ${sheet.description?.personalityTraits ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Personality Traits</div>
                                <div class="text-white text-sm">${sheet.description.personalityTraits}</div>
                            </div>
                            ` : ''}
                            
                            ${sheet.description?.ideals ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Ideals</div>
                                <div class="text-white text-sm">${sheet.description.ideals}</div>
                            </div>
                            ` : ''}
                            
                            ${sheet.description?.bonds ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Bonds</div>
                                <div class="text-white text-sm">${sheet.description.bonds}</div>
                            </div>
                            ` : ''}
                            
                            ${sheet.description?.flaws ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Flaws</div>
                                <div class="text-white text-sm">${sheet.description.flaws}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Backstory</h3>
                        <div class="space-y-4">
                            ${sheet.description?.backstory ? `
                            <div class="text-white text-sm">${sheet.description.backstory}</div>
                            ` : '<div class="text-gray-300">No backstory provided</div>'}
                            
                            ${sheet.description?.allies ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Allies & Organizations</div>
                                <div class="text-white text-sm">${sheet.description.allies}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateNotesTab(sheet) {
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Notes</h3>
                        <textarea class="w-full h-64 bg-gray-700 text-white rounded p-3 resize-none" placeholder="Enter your notes here...">${sheet.notes}</textarea>
                    </div>
                </div>
            `;
        }
        
        function generateExtrasTab(sheet) {
            // Display companions if available
            const companionsContent = sheet.extras?.companions && sheet.extras.companions.length > 0 
                ? sheet.extras.companions.map(companion => `
                    <div class="bg-gray-700 rounded p-3">
                        <div class="font-semibold text-white">${companion.name}</div>
                        <div class="text-sm text-gray-400">${companion.type || 'Companion'}</div>
                        ${companion.description ? `<div class="text-sm text-gray-300 mt-1">${companion.description}</div>` : ''}
                        ${companion.stats ? `
                        <div class="text-xs text-gray-400 mt-1">
                            AC: ${companion.stats.ac || 'N/A'} | 
                            HP: ${companion.stats.hp || 'N/A'} | 
                            Speed: ${companion.stats.speed || 'N/A'}
                        </div>
                        ` : ''}
                    </div>
                `).join('')
                : '<div class="text-gray-300">No companions</div>';
            
            // Display other extras
            const extrasContent = sheet.extras?.other && sheet.extras.other.length > 0
                ? sheet.extras.other.map(extra => `
                    <div class="bg-gray-700 rounded p-3">
                        <div class="font-semibold text-white">${extra.name}</div>
                        <div class="text-sm text-gray-400">${extra.category || 'Extra'}</div>
                        ${extra.description ? `<div class="text-sm text-gray-300 mt-1">${extra.description}</div>` : ''}
                    </div>
                `).join('')
                : '<div class="text-gray-300">No additional extras</div>';
            
            return `
                <div class="space-y-6">
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Proficiencies</h3>
                        <div class="space-y-3">
                            ${sheet.proficiencies?.languages ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Languages</div>
                                <div class="text-white text-sm">${Array.isArray(sheet.proficiencies.languages) ? sheet.proficiencies.languages.join(', ') : sheet.proficiencies.languages}</div>
                            </div>
                            ` : ''}
                            
                            ${sheet.proficiencies?.weapons ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Weapon Proficiencies</div>
                                <div class="text-white text-sm">${Array.isArray(sheet.proficiencies.weapons) ? sheet.proficiencies.weapons.join(', ') : sheet.proficiencies.weapons}</div>
                            </div>
                            ` : ''}
                            
                            ${sheet.proficiencies?.armor ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Armor Proficiencies</div>
                                <div class="text-white text-sm">${Array.isArray(sheet.proficiencies.armor) ? sheet.proficiencies.armor.join(', ') : sheet.proficiencies.armor}</div>
                            </div>
                            ` : ''}
                            
                            ${sheet.proficiencies?.tools ? `
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Tool Proficiencies</div>
                                <div class="text-white text-sm">${Array.isArray(sheet.proficiencies.tools) ? sheet.proficiencies.tools.join(', ') : sheet.proficiencies.tools}</div>
                            </div>
                            ` : ''}
                        </div>
                        ${!sheet.proficiencies && '<div class="text-gray-300">No proficiencies configured</div>'}
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Companions & Familiars</h3>
                        <div class="space-y-2">
                            ${companionsContent}
                        </div>
                    </div>
                    
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Additional Extras</h3>
                        <div class="space-y-2">
                            ${extrasContent}
                        </div>
                    </div>
                    
                    ${sheet.extras?.treasure ? `
                    <div class="stat-block rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-400 mb-3">Treasure & Valuables</h3>
                        <div class="text-white text-sm">${sheet.extras.treasure}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Panel Management Functions
        function showPanel(panelName) {
            // Update active tab
            document.querySelectorAll('#sidebar-panel .btn-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            const activeTab = document.querySelector(`[data-panel="${panelName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');
            }
            
            // Update panel content
            appState.currentPanel = panelName;
            const content = document.getElementById('panel-content');
            content.innerHTML = generatePanelContent(panelName);
            
            // Setup panel-specific event handlers
            setupPanelHandlers(panelName);
        }
        
        function generatePanelContent(panelName) {
            switch (panelName) {
                case 'party':
                    return generatePartyPanel();
                case 'initiative':
                    return generateInitiativePanel();
                case 'tokens':
                    return generateTokenMakerPanel();
                case 'maps':
                    return generateMapsPanel();
                default:
                    return '<div class="text-white">Panel content not implemented yet.</div>';
            }
        }
        
        function generatePartyPanel() {
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-green-400">Party Manager</h3>
                        <button id="add-party-member" class="btn-primary text-sm" aria-label="Add new party member">
                            <span class="icon">‚ûï</span> Add Member
                        </button>
                    </div>
                    
                    <div id="party-list" class="space-y-2">
                        ${appState.party.length === 0 ? 
                            '<div class="text-gray-400 text-sm text-center py-4">No party members yet</div>' :
                            appState.party.map(member => `
                                <div class="party-member bg-gray-800 rounded p-3 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full" style="background-color: ${member.color}"></div>
                                        <div>
                                            <div class="text-white font-semibold">${member.name}</div>
                                            <div class="text-gray-400 text-xs">${member.class} Level ${member.level}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-green-400">${member.hp}/${member.maxHp} HP</span>
                                        <button class="text-red-400 hover:text-red-300" onclick="removePartyMember('${member.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }
        
        function generateInitiativePanel() {
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-green-400">Initiative Tracker</h3>
                        <div class="flex gap-2">
                            <button id="roll-initiative" class="btn-secondary text-sm" aria-label="Roll initiative for all participants">
                                üé≤ Roll Initiative
                            </button>
                            <button id="next-turn" class="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                                ‚è≠Ô∏è Next Turn
                            </button>
                        </div>
                    </div>
                    
                    <div id="initiative-list" class="space-y-2">
                        ${appState.initiative.length === 0 ? 
                            '<div class="text-gray-400 text-sm text-center py-4">No initiative order set</div>' :
                            appState.initiative.map((entry, index) => `
                                <div class="initiative-entry bg-gray-800 rounded p-3 flex items-center justify-between ${entry.isActive ? 'ring-2 ring-yellow-400' : ''}">
                                    <div class="flex items-center gap-3">
                                        <div class="text-lg font-bold text-yellow-400">${entry.initiative}</div>
                                        <div>
                                            <div class="text-white font-semibold">${entry.name}</div>
                                            <div class="text-gray-400 text-xs">${entry.type}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${entry.isActive ? '<span class="text-yellow-400">üîÑ</span>' : ''}
                                        <button class="text-red-400 hover:text-red-300" onclick="removeFromInitiative('${entry.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }
        
        function generateTokenMakerPanel() {
            return `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-green-400">Token Maker</h3>
                    
                    <!-- Token Preview -->
                    <div class="text-center">
                        <div id="token-preview" class="w-16 h-16 rounded-full mx-auto mb-2" style="background-color: #ef4444; border: 2px solid #ffffff;"></div>
                        <div class="text-sm text-gray-300">Preview</div>
                    </div>
                    
                    <!-- Token Properties -->
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-300 block mb-1">Name:</label>
                            <input id="token-name" type="text" value="New Token" class="w-full bg-gray-700 text-white px-3 py-2 rounded text-sm">
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-300 block mb-1">Type:</label>
                            <select id="token-type" class="w-full bg-gray-700 text-white px-3 py-2 rounded text-sm">
                                <option value="player">Player Character</option>
                                <option value="npc">NPC</option>
                                <option value="enemy">Enemy</option>
                                <option value="object">Object</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-300 block mb-1">Color:</label>
                            <div class="grid grid-cols-5 gap-2 mb-2">
                                <button class="btn-color selected" style="background-color: #ef4444" data-color="#ef4444" aria-label="Select red color"></button>
                                <button class="btn-color" style="background-color: #3b82f6" data-color="#3b82f6" aria-label="Select blue color"></button>
                                <button class="btn-color" style="background-color: #10b981" data-color="#10b981" aria-label="Select green color"></button>
                                <button class="btn-color" style="background-color: #f59e0b" data-color="#f59e0b" aria-label="Select yellow color"></button>
                                <button class="btn-color" style="background-color: #8b5cf6" data-color="#8b5cf6" aria-label="Select purple color"></button>
                                <button class="btn-color" style="background-color: #ec4899" data-color="#ec4899" aria-label="Select pink color"></button>
                                <button class="btn-color" style="background-color: #6b7280" data-color="#6b7280" aria-label="Select gray color"></button>
                                <button class="btn-color" style="background-color: #374151" data-color="#374151" aria-label="Select dark gray color"></button>
                                <button class="btn-color" style="background-color: #7c3aed" data-color="#7c3aed" aria-label="Select violet color"></button>
                                <button class="btn-color" style="background-color: #dc2626" data-color="#dc2626" aria-label="Select dark red color"></button>
                            </div>
                            <input id="custom-color" type="color" value="#ef4444" class="w-full h-8 bg-gray-700 rounded">
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-300 block mb-1">Size:</label>
                            <input id="token-size" type="range" min="10" max="50" value="20" class="w-full">
                            <div class="text-xs text-gray-400 text-center">
                                <span id="size-display">20</span> pixels
                            </div>
                        </div>
                        
                        <button id="create-token" class="btn-primary w-full" aria-label="Create new token">
                            Create Token
                        </button>
                        
                        <button id="update-selected-token" class="btn-secondary w-full hidden" aria-label="Update selected token properties">
                            Update Selected Token
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateMapsPanel() {
            const currentMap = appState.maps[appState.currentMapId];
            const mapsList = Object.values(appState.maps);
            
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-green-400">Maps Manager</h3>
                        <button id="create-sub-map" class="btn-primary text-sm" aria-label="Create new sub map">
                            <span class="icon">‚ûï</span> New Map
                        </button>
                    </div>
                    
                    <!-- Current Map Info -->
                    <div class="bg-gray-800 rounded p-3">
                        <div class="text-sm text-gray-300 mb-1">Current Map:</div>
                        <div class="text-white font-semibold">${currentMap.name}</div>
                        <div class="text-xs text-gray-400 mt-1">
                            Tokens: ${currentMap.tokens.length} | 
                            Background: ${currentMap.backgroundImageName || 'None'}
                        </div>
                    </div>
                    
                    <!-- Maps List -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-300 mb-2">Available Maps:</div>
                        ${mapsList.map(map => `
                            <div class="map-item bg-gray-800 rounded p-3 flex items-center justify-between ${map.id === appState.currentMapId ? 'ring-2 ring-green-500' : ''}">
                                <div class="flex-1">
                                    <div class="text-white font-medium">${map.name}</div>
                                    <div class="text-xs text-gray-400">
                                        ${map.tokens.length} tokens | ${map.backgroundImageName || 'No background'}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${map.id !== appState.currentMapId ? `
                                        <button class="btn-secondary text-xs switch-map" data-map-id="${map.id}" aria-label="Switch to ${map.name}">
                                            Switch
                                        </button>
                                    ` : `
                                        <span class="text-green-400 text-xs">Active</span>
                                    `}
                                    ${map.id !== 'main' ? `
                                        <button class="btn-danger text-xs delete-map" data-map-id="${map.id}" aria-label="Delete ${map.name}">
                                            Delete
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Tools Status -->
                    <div class="bg-gray-800 rounded p-3">
                        <div class="text-sm text-gray-300 mb-2">Map Tools Status:</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="text-gray-400">Move: <span class="text-green-400">‚úì Working</span></div>
                            <div class="text-gray-400">Ruler: <span class="text-green-400">‚úì Working</span></div>
                            <div class="text-gray-400">Fog: <span class="text-green-400">‚úì Working</span></div>
                            <div class="text-gray-400">Tokens: <span class="text-green-400">‚úì Working</span></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">All map tools work in sub maps!</div>
                    </div>
                </div>
            `;
        }
        
        function setupPanelHandlers(panelName) {
            switch (panelName) {
                case 'party':
                    setupPartyHandlers();
                    break;
                case 'initiative':
                    setupInitiativeHandlers();
                    break;
                case 'tokens':
                    setupTokenMakerHandlers();
                    break;
                case 'maps':
                    setupMapsHandlers();
                    break;
            }
        }
        
        function setupPartyHandlers() {
            const addBtn = document.getElementById('add-party-member');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    // Add a party member from selected token or create new
                    if (appState.selectedToken) {
                        addToParty(appState.selectedToken);
                    } else {
                        // Create new party member
                        const newMember = {
                            id: Date.now().toString(),
                            name: 'New Member',
                            class: 'Fighter',
                            level: 1,
                            hp: 10,
                            maxHp: 10,
                            color: '#10b981'
                        };
                        appState.party.push(newMember);
                        showPanel('party');
                        addChatMessage(`Added ${newMember.name} to party`, 'system');
                    }
                });
            }
        }
        
        function setupInitiativeHandlers() {
            const rollBtn = document.getElementById('roll-initiative');
            const nextBtn = document.getElementById('next-turn');
            
            if (rollBtn) {
                rollBtn.addEventListener('click', () => {
                    rollInitiativeForAll();
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    nextTurn();
                });
            }
        }
        
        function setupTokenMakerHandlers() {
            const nameInput = document.getElementById('token-name');
            const typeSelect = document.getElementById('token-type');
            const customColor = document.getElementById('custom-color');
            const sizeSlider = document.getElementById('token-size');
            const sizeDisplay = document.getElementById('size-display');
            const createBtn = document.getElementById('create-token');
            const updateBtn = document.getElementById('update-selected-token');
            const preview = document.getElementById('token-preview');
            
            // Color selection
            document.querySelectorAll('.btn-color').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update selection state
                    document.querySelectorAll('.btn-color').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    const color = btn.dataset.color;
                    customColor.value = color;
                    preview.style.backgroundColor = color;
                });
            });
            
            customColor.addEventListener('input', () => {
                preview.style.backgroundColor = customColor.value;
                // Reset color button selections
                document.querySelectorAll('.btn-color').forEach(b => b.classList.remove('selected'));
            });
            
            // Size slider
            sizeSlider.addEventListener('input', () => {
                const size = sizeSlider.value;
                sizeDisplay.textContent = size;
                preview.style.width = size + 'px';
                preview.style.height = size + 'px';
            });
            
            // Create token
            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    createTokenFromMaker();
                });
            }
            
            // Update selected token
            if (updateBtn) {
                updateBtn.addEventListener('click', () => {
                    updateSelectedTokenFromMaker();
                });
            }
            
            // Update UI based on selected token
            if (appState.selectedToken) {
                nameInput.value = appState.selectedToken.name;
                typeSelect.value = appState.selectedToken.type;
                customColor.value = appState.selectedToken.color;
                sizeSlider.value = appState.selectedToken.size;
                sizeDisplay.textContent = appState.selectedToken.size;
                preview.style.backgroundColor = appState.selectedToken.color;
                preview.style.width = appState.selectedToken.size + 'px';
                preview.style.height = appState.selectedToken.size + 'px';
                
                updateBtn.classList.remove('hidden');
                createBtn.textContent = 'Create New Token';
            } else {
                updateBtn.classList.add('hidden');
                createBtn.textContent = 'Create Token';
            }
        }
        
        function setupMapsHandlers() {
            const createMapBtn = document.getElementById('create-sub-map');
            
            if (createMapBtn) {
                createMapBtn.addEventListener('click', () => {
                    createSubMap();
                });
            }
            
            // Switch map buttons
            document.querySelectorAll('.switch-map').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mapId = e.target.getAttribute('data-map-id');
                    switchToMap(mapId);
                });
            });
            
            // Delete map buttons
            document.querySelectorAll('.delete-map').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mapId = e.target.getAttribute('data-map-id');
                    deleteMap(mapId);
                });
            });
        }
        
        // Sub Map Management Functions
        function createSubMap() {
            // Show the map creation modal instead of simple prompt
            showMapCreationModal();
        }
        
        function showMapCreationModal() {
            const modal = document.getElementById('map-creation-modal');
            const mapNameInput = document.getElementById('map-name-input');
            
            // Clear previous values
            mapNameInput.value = `Sub Map ${Object.keys(appState.maps).length}`;
            clearUploadPreview();
            clearSelectedImage();
            
            // Populate image gallery
            populateImageGallery();
            
            // Show modal
            modal.classList.remove('hidden');
            mapNameInput.focus();
        }
        
        function populateImageGallery() {
            const gallery = document.getElementById('image-gallery');
            const noImagesMessage = document.getElementById('no-images-message');
            
            // Clear existing content
            gallery.innerHTML = '';
            
            if (appState.uploadedFiles.images.length === 0) {
                noImagesMessage.classList.remove('hidden');
                return;
            }
            
            noImagesMessage.classList.add('hidden');
            
            appState.uploadedFiles.images.forEach((imageFile, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-gallery-item flex items-center bg-gray-800 rounded p-3 hover:bg-gray-700 cursor-pointer transition-colors';
                imageItem.dataset.imageIndex = index;
                
                imageItem.innerHTML = `
                    <div class="w-16 h-16 bg-gray-700 rounded mr-3 overflow-hidden">
                        <img class="w-full h-full object-cover" src="${imageFile.image.src}" alt="${imageFile.name}">
                    </div>
                    <div class="flex-1">
                        <div class="text-white font-medium">${imageFile.name}</div>
                        <div class="text-xs text-gray-400">Uploaded ${imageFile.timestamp.toLocaleDateString()}</div>
                    </div>
                    <div class="text-green-400 hidden selected-indicator">‚úì</div>
                `;
                
                imageItem.addEventListener('click', () => selectGalleryImage(index, imageItem));
                gallery.appendChild(imageItem);
            });
        }
        
        let selectedImageIndex = null;
        let uploadedImageData = null;
        
        function selectGalleryImage(index, element) {
            // Clear previous selection
            document.querySelectorAll('.image-gallery-item').forEach(item => {
                item.classList.remove('ring-2', 'ring-green-500');
                item.querySelector('.selected-indicator').classList.add('hidden');
            });
            
            // Select new image
            element.classList.add('ring-2', 'ring-green-500');
            element.querySelector('.selected-indicator').classList.remove('hidden');
            selectedImageIndex = index;
            uploadedImageData = null; // Clear uploaded image data
        }
        
        function clearSelectedImage() {
            document.querySelectorAll('.image-gallery-item').forEach(item => {
                item.classList.remove('ring-2', 'ring-green-500');
                item.querySelector('.selected-indicator').classList.add('hidden');
            });
            selectedImageIndex = null;
        }
        
        function clearUploadPreview() {
            const preview = document.getElementById('upload-preview');
            preview.classList.add('hidden');
            uploadedImageData = null;
        }
        
        function createMapWithImage() {
            const mapNameInput = document.getElementById('map-name-input');
            const mapName = mapNameInput.value.trim();
            
            if (!mapName) {
                addChatMessage('Please enter a map name', 'system');
                return;
            }
            
            const mapId = 'map_' + Date.now();
            let backgroundImage = null;
            let backgroundImageName = null;
            
            // Determine which image to use
            if (uploadedImageData) {
                // Use newly uploaded image
                backgroundImage = uploadedImageData.image;
                backgroundImageName = uploadedImageData.name;
                
                // Add to uploaded files if not already there
                const existingImage = appState.uploadedFiles.images.find(img => img.name === uploadedImageData.name);
                if (!existingImage) {
                    appState.uploadedFiles.images.push({
                        name: uploadedImageData.name,
                        image: uploadedImageData.image,
                        timestamp: new Date()
                    });
                }
            } else if (selectedImageIndex !== null) {
                // Use selected existing image
                const selectedImage = appState.uploadedFiles.images[selectedImageIndex];
                backgroundImage = selectedImage.image;
                backgroundImageName = selectedImage.name;
            }
            
            // Create the map
            appState.maps[mapId] = {
                id: mapId,
                name: mapName,
                backgroundImage: backgroundImage,
                backgroundImageName: backgroundImageName,
                tokens: [],
                camera: { x: 0, y: 0 },
                zoom: 1.0,
                fogOfWar: []
            };
            
            // Close modal
            document.getElementById('map-creation-modal').classList.add('hidden');
            
            // Refresh the maps panel
            showPanel('maps');
            
            const imageMessage = backgroundImageName ? ` with background image: ${backgroundImageName}` : '';
            addChatMessage(`Created new sub map: ${mapName}${imageMessage}`, 'system');
        }
        
        function switchToMap(mapId) {
            if (appState.maps[mapId]) {
                // Save current map state
                saveCurrentMapState();
                
                // Switch to new map
                appState.currentMapId = mapId;
                loadMapState(mapId);
                
                // Refresh UI
                showPanel('maps');
                redrawCanvas();
                updateTokenCount();
                
                addChatMessage(`Switched to map: ${appState.maps[mapId].name}`, 'system');
            }
        }
        
        function deleteMap(mapId) {
            if (mapId === 'main') {
                addChatMessage('Cannot delete the main map', 'system');
                return;
            }
            
            if (confirm(`Are you sure you want to delete the map "${appState.maps[mapId].name}"?`)) {
                // If deleting current map, switch to main
                if (appState.currentMapId === mapId) {
                    switchToMap('main');
                }
                
                delete appState.maps[mapId];
                showPanel('maps');
                addChatMessage(`Deleted map: ${appState.maps[mapId]?.name || 'Unknown'}`, 'system');
            }
        }
        
        function saveCurrentMapState() {
            const currentMap = appState.maps[appState.currentMapId];
            if (currentMap) {
                currentMap.tokens = [...appState.tokens];
                currentMap.camera = { ...appState.camera };
                currentMap.zoom = appState.zoom;
                currentMap.backgroundImage = appState.backgroundImage;
                currentMap.backgroundImageName = appState.backgroundImageName;
                currentMap.fogOfWar = [...appState.fogOfWar];
            }
        }
        
        function loadMapState(mapId) {
            const map = appState.maps[mapId];
            if (map) {
                appState.tokens = [...map.tokens];
                appState.camera = { ...map.camera };
                appState.zoom = map.zoom;
                appState.backgroundImage = map.backgroundImage;
                appState.backgroundImageName = map.backgroundImageName;
                appState.fogOfWar = [...map.fogOfWar];
                
                updateZoomDisplay();
                updateBackgroundDisplay();
            }
        }
        
        function updateTokenCount() {
            const tokenCountElement = document.getElementById('token-count');
            if (tokenCountElement) {
                tokenCountElement.textContent = appState.tokens.length;
            }
        }
        
        // Party Management Functions
        function addToParty(token) {
            const member = {
                id: token.id.toString(),
                name: token.name,
                class: token.characterSheet.class,
                level: token.characterSheet.level,
                hp: token.characterSheet.health.current,
                maxHp: token.characterSheet.health.max,
                color: token.color
            };
            
            // Check if already in party
            if (!appState.party.find(p => p.id === member.id)) {
                appState.party.push(member);
                showPanel('party');
                addChatMessage(`Added ${member.name} to party`, 'system');
            }
        }
        
        function removePartyMember(id) {
            appState.party = appState.party.filter(member => member.id !== id);
            showPanel('party');
            addChatMessage(`Removed party member`, 'system');
        }
        
        // Initiative Management Functions
        function rollInitiativeForAll() {
            appState.initiative = [];
            
            // Add party members to initiative
            appState.party.forEach(member => {
                const initiative = Math.floor(Math.random() * 20) + 1;
                appState.initiative.push({
                    id: member.id,
                    name: member.name,
                    type: 'Player',
                    initiative: initiative,
                    isActive: false
                });
            });
            
            // Add enemies/NPCs from tokens
            appState.tokens.filter(t => t.type === 'enemy' || t.type === 'npc').forEach(token => {
                const initiative = Math.floor(Math.random() * 20) + 1;
                appState.initiative.push({
                    id: token.id.toString(),
                    name: token.name,
                    type: token.type === 'enemy' ? 'Enemy' : 'NPC',
                    initiative: initiative,
                    isActive: false
                });
            });
            
            // Sort by initiative (highest first)
            appState.initiative.sort((a, b) => b.initiative - a.initiative);
            
            // Set first entry as active
            if (appState.initiative.length > 0) {
                appState.initiative[0].isActive = true;
            }
            
            showPanel('initiative');
            addChatMessage(`Initiative rolled for ${appState.initiative.length} participants`, 'system');
        }
        
        function nextTurn() {
            if (appState.initiative.length === 0) return;
            
            const currentIndex = appState.initiative.findIndex(entry => entry.isActive);
            if (currentIndex !== -1) {
                appState.initiative[currentIndex].isActive = false;
                const nextIndex = (currentIndex + 1) % appState.initiative.length;
                appState.initiative[nextIndex].isActive = true;
                
                showPanel('initiative');
                addChatMessage(`Next turn: ${appState.initiative[nextIndex].name}`, 'system');
            }
        }
        
        function removeFromInitiative(id) {
            appState.initiative = appState.initiative.filter(entry => entry.id !== id);
            showPanel('initiative');
        }
        
        // Dice Functions
        
        // Token Maker Functions
        function createTokenFromMaker() {
            const name = document.getElementById('token-name').value;
            const type = document.getElementById('token-type').value;
            const color = document.getElementById('custom-color').value;
            const size = parseInt(document.getElementById('token-size').value);
            
            // Create token at center of canvas
            const centerX = canvas.width / 2 - appState.camera.x;
            const centerY = canvas.height / 2 - appState.camera.y;
            
            const token = {
                id: Date.now(),
                x: centerX,
                y: centerY,
                color: color,
                size: size,
                type: type,
                name: name,
                characterSheet: createDefaultCharacterSheet(),
                pdfUrl: null
            };
            
            // Update character sheet with token name and type
            token.characterSheet.name = name;
            if (type === 'enemy') {
                token.characterSheet.class = 'Monster';
            }
            
            appState.tokens.push(token);
            document.getElementById('token-count').textContent = appState.tokens.length;
            redrawCanvas();
            addChatMessage(`Created ${name} token`, 'system');
        }
        
        function updateSelectedTokenFromMaker() {
            if (!appState.selectedToken) return;
            
            const name = document.getElementById('token-name').value;
            const type = document.getElementById('token-type').value;
            const color = document.getElementById('custom-color').value;
            const size = parseInt(document.getElementById('token-size').value);
            
            appState.selectedToken.name = name;
            appState.selectedToken.type = type;
            appState.selectedToken.color = color;
            appState.selectedToken.size = size;
            appState.selectedToken.characterSheet.name = name;
            
            redrawCanvas();
            addChatMessage(`Updated ${name} token`, 'system');
        }
        
        // Upload functionality
        function setupUploadHandlers() {
            const uploadBtn = document.getElementById('upload-campaign');
            const uploadModal = document.getElementById('upload-modal');
            const closeUploadBtn = document.getElementById('close-upload-modal');
            
            // Campaign file handling
            const campaignDropArea = document.getElementById('campaign-drop-area');
            const campaignFileInput = document.getElementById('campaign-file-input');
            
            // PDF file handling
            const pdfDropArea = document.getElementById('pdf-drop-area');
            const pdfFileInput = document.getElementById('pdf-file-input');
            
            // Open upload modal
            uploadBtn.addEventListener('click', () => {
                uploadModal.classList.remove('hidden');
            });
            
            // Close upload modal
            closeUploadBtn.addEventListener('click', () => {
                uploadModal.classList.add('hidden');
            });
            
            // Upload Expansion button
            const uploadExpansionBtn = document.getElementById('upload-expansion');
            uploadExpansionBtn.addEventListener('click', () => {
                addChatMessage('Upload Expansion feature - Ready for future modules and expansions!', 'system');
                // TODO: Implement expansion upload functionality
            });
            
            // Campaign file drag & drop
            campaignDropArea.addEventListener('click', () => campaignFileInput.click());
            campaignDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                campaignDropArea.classList.add('drag-over');
            });
            campaignDropArea.addEventListener('dragleave', () => {
                campaignDropArea.classList.remove('drag-over');
            });
            campaignDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                campaignDropArea.classList.remove('drag-over');
                handleCampaignFiles(e.dataTransfer.files);
            });
            campaignFileInput.addEventListener('change', (e) => {
                handleCampaignFiles(e.target.files);
            });
            
            // PDF file drag & drop
            pdfDropArea.addEventListener('click', () => pdfFileInput.click());
            pdfDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                pdfDropArea.classList.add('drag-over');
            });
            pdfDropArea.addEventListener('dragleave', () => {
                pdfDropArea.classList.remove('drag-over');
            });
            pdfDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                pdfDropArea.classList.remove('drag-over');
                handlePdfFiles(e.dataTransfer.files);
            });
            pdfFileInput.addEventListener('change', (e) => {
                handlePdfFiles(e.target.files);
            });
            
            // Image file drag & drop
            const imageDropArea = document.getElementById('image-drop-area');
            const imageFileInput = document.getElementById('image-file-input');
            imageDropArea.addEventListener('click', () => imageFileInput.click());
            imageDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageDropArea.classList.add('drag-over');
            });
            imageDropArea.addEventListener('dragleave', () => {
                imageDropArea.classList.remove('drag-over');
            });
            imageDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageDropArea.classList.remove('drag-over');
                handleImageFiles(e.dataTransfer.files);
            });
            imageFileInput.addEventListener('change', (e) => {
                handleImageFiles(e.target.files);
            });
            
            // Clear background button
            const clearBackgroundBtn = document.getElementById('clear-background');
            clearBackgroundBtn.addEventListener('click', () => {
                clearBackgroundImage();
            });
        }
        
        function handleCampaignFiles(files) {
            Array.from(files).forEach(file => {
                addChatMessage(`Campaign file uploaded: ${file.name}`, 'system');
                appState.uploadedFiles.campaigns.push({
                    name: file.name,
                    file: file,
                    timestamp: new Date()
                });
                
                // Parse campaign file (simplified implementation)
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            addChatMessage(`Parsed campaign data: ${Object.keys(data).join(', ')}`, 'system');
                        } catch (error) {
                            addChatMessage(`Error parsing campaign file: ${error.message}`, 'system');
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }
        
        function handlePdfFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'application/pdf') {
                    const url = URL.createObjectURL(file);
                    appState.uploadedFiles.pdfs.push({
                        name: file.name,
                        url: url,
                        timestamp: new Date()
                    });
                    addChatMessage(`Enemy PDF uploaded: ${file.name}`, 'system');
                } else {
                    addChatMessage(`Invalid file type. Please upload PDF files only.`, 'system');
                }
            });
        }
        
        function handleImageFiles(files) {
            Array.from(files).forEach(file => {
                // Check if file is an image
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // Set as background image
                            appState.backgroundImage = img;
                            appState.backgroundImageName = file.name;
                            
                            // Store in uploaded files
                            appState.uploadedFiles.images.push({
                                name: file.name,
                                image: img,
                                timestamp: new Date()
                            });
                            
                            // Update UI
                            updateBackgroundDisplay();
                            redrawCanvas();
                            
                            addChatMessage(`Background image loaded: ${file.name}`, 'system');
                        };
                        img.onerror = () => {
                            addChatMessage(`Error loading image: ${file.name}`, 'system');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    addChatMessage(`Invalid file type. Please upload image files only (PNG, JPG, JPEG, GIF, WebP).`, 'system');
                }
            });
        }
        
        function clearBackgroundImage() {
            appState.backgroundImage = null;
            appState.backgroundImageName = null;
            updateBackgroundDisplay();
            redrawCanvas();
            addChatMessage('Background image cleared', 'system');
        }
        
        function updateBackgroundDisplay() {
            const currentBackground = document.getElementById('current-background');
            const currentBackgroundName = document.getElementById('current-background-name');
            
            if (appState.backgroundImageName) {
                currentBackground.classList.remove('hidden');
                currentBackgroundName.textContent = appState.backgroundImageName;
            } else {
                currentBackground.classList.add('hidden');
                currentBackgroundName.textContent = 'None';
            }
        }
        
        function handleMapImageFiles(files) {
            // Handle image files for map creation modal
            Array.from(files).forEach(file => {
                // Check if file is an image
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // Store the uploaded image data for map creation
                            uploadedImageData = {
                                name: file.name,
                                image: img,
                                timestamp: new Date()
                            };
                            
                            // Show preview
                            showUploadPreview(uploadedImageData);
                            
                            // Clear any selected gallery image
                            clearSelectedImage();
                            
                            addChatMessage(`Map image ready for upload: ${file.name}`, 'system');
                        };
                        img.onerror = () => {
                            addChatMessage(`Error loading image: ${file.name}`, 'system');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    addChatMessage(`Invalid file type. Please upload image files only (PNG, JPG, JPEG, GIF, WebP).`, 'system');
                }
            });
        }
        
        function showUploadPreview(imageData) {
            const preview = document.getElementById('upload-preview');
            const previewImg = document.getElementById('upload-preview-img');
            const previewName = document.getElementById('upload-preview-name');
            
            previewImg.src = imageData.image.src;
            previewName.textContent = imageData.name;
            preview.classList.remove('hidden');
        }
        
        function setupModalHandlers() {
            // Character sheet modal
            const characterModal = document.getElementById('character-sheet-modal');
            const closeCharacterBtn = document.getElementById('close-character-sheet');
            const expandCharacterBtn = document.getElementById('expand-character-sheet');
            
            closeCharacterBtn.addEventListener('click', () => {
                characterModal.classList.add('hidden');
            });
            
            expandCharacterBtn.addEventListener('click', () => {
                // TODO: Implement full-screen character sheet
                addChatMessage('Full-screen character sheet not yet implemented', 'system');
            });
            
            // Character sheet tabs
            document.querySelectorAll('.character-sheet-tabs .btn-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    if (appState.selectedToken) {
                        showCharacterTab(tabName, appState.selectedToken.characterSheet);
                    }
                });
            });
            
            // PDF viewer modal
            const pdfModal = document.getElementById('pdf-viewer-modal');
            const closePdfBtn = document.getElementById('close-pdf-viewer');
            
            closePdfBtn.addEventListener('click', () => {
                pdfModal.classList.add('hidden');
            });
            
            // Map creation modal
            const mapCreationModal = document.getElementById('map-creation-modal');
            const closeMapCreationBtn = document.getElementById('close-map-creation-modal');
            const cancelMapCreationBtn = document.getElementById('cancel-map-creation');
            const createMapConfirmBtn = document.getElementById('create-map-confirm');
            const uploadNewTab = document.getElementById('upload-new-tab');
            const selectExistingTab = document.getElementById('select-existing-tab');
            const uploadNewContent = document.getElementById('upload-new-content');
            const selectExistingContent = document.getElementById('select-existing-content');
            const mapImageDropArea = document.getElementById('map-image-drop-area');
            const mapImageFileInput = document.getElementById('map-image-file-input');
            const clearUploadPreviewBtn = document.getElementById('clear-upload-preview');
            
            // Close modal handlers
            closeMapCreationBtn.addEventListener('click', () => {
                mapCreationModal.classList.add('hidden');
            });
            
            cancelMapCreationBtn.addEventListener('click', () => {
                mapCreationModal.classList.add('hidden');
            });
            
            // Create map button
            createMapConfirmBtn.addEventListener('click', () => {
                createMapWithImage();
            });
            
            // Tab switching
            uploadNewTab.addEventListener('click', () => {
                uploadNewTab.classList.add('active', 'text-green-400', 'border-green-400');
                uploadNewTab.classList.remove('text-gray-400', 'border-transparent');
                selectExistingTab.classList.remove('active', 'text-green-400', 'border-green-400');
                selectExistingTab.classList.add('text-gray-400', 'border-transparent');
                uploadNewContent.classList.remove('hidden');
                selectExistingContent.classList.add('hidden');
            });
            
            selectExistingTab.addEventListener('click', () => {
                selectExistingTab.classList.add('active', 'text-green-400', 'border-green-400');
                selectExistingTab.classList.remove('text-gray-400', 'border-transparent');
                uploadNewTab.classList.remove('active', 'text-green-400', 'border-green-400');
                uploadNewTab.classList.add('text-gray-400', 'border-transparent');
                selectExistingContent.classList.remove('hidden');
                uploadNewContent.classList.add('hidden');
                populateImageGallery(); // Refresh gallery when tab is opened
            });
            
            // Image upload handlers
            mapImageDropArea.addEventListener('click', () => mapImageFileInput.click());
            mapImageDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                mapImageDropArea.classList.add('border-green-500');
                mapImageDropArea.classList.remove('border-gray-600');
            });
            mapImageDropArea.addEventListener('dragleave', () => {
                mapImageDropArea.classList.remove('border-green-500');
                mapImageDropArea.classList.add('border-gray-600');
            });
            mapImageDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                mapImageDropArea.classList.remove('border-green-500');
                mapImageDropArea.classList.add('border-gray-600');
                handleMapImageFiles(e.dataTransfer.files);
            });
            mapImageFileInput.addEventListener('change', (e) => {
                handleMapImageFiles(e.target.files);
            });
            
            // Clear upload preview
            clearUploadPreviewBtn.addEventListener('click', () => {
                clearUploadPreview();
            });
            
            // Close modals on background click
            const uploadModal = document.getElementById('upload-modal');
            [uploadModal, characterModal, pdfModal, mapCreationModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        }
        // Legacy chat elements (for compatibility with existing references)
        const chatMessages = document.getElementById('chat-messages') || document.createElement('div');
        const chatInput = document.getElementById('chat-input') || null;
        const sendButton = document.getElementById('send-chat') || null;
        
        function addChatMessage(message, type = 'user') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-1 text-xs ${type === 'system' ? 'text-green-400' : type === 'dice' ? 'text-yellow-400' : 'text-white'}`;
            messageDiv.textContent = message;
            if (chatMessages && chatMessages.appendChild) {
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Also log to console for debugging
            console.log(`[${type}] ${message}`);
        }
        
        function rollDice(diceString) {
            const match = diceString.match(/(\d+)d(\d+)(?:\+(\d+))?/);
            if (!match) return null;
            
            const count = parseInt(match[1]);
            const sides = parseInt(match[2]);
            const modifier = parseInt(match[3]) || 0;
            
            const rolls = [];
            let total = modifier;
            
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            
            return {
                rolls,
                total,
                modifier,
                diceString
            };
        }
        
        // Note: All dice and chat functionality now handled by Control Center
        
        // Control Center Functionality
        const controlCenter = document.getElementById('control-center');
        const controlCenterToggle = document.getElementById('control-center-toggle');
        const controlCenterClose = document.getElementById('control-center-close');
        const controlCenterHeader = document.getElementById('control-center-header');
        const resizeHandles = document.querySelectorAll('.resize-handle');
        
        let isControlCenterDragging = false;
        let isResizing = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let windowStartX = 0;
        let windowStartY = 0;
        let resizeStartX = 0;
        let resizeStartY = 0;
        let windowStartWidth = 0;
        let windowStartHeight = 0;
        let currentResizeHandle = null;
        
        // Control Center Toggle Functionality
        if (controlCenterToggle) {
            controlCenterToggle.addEventListener('click', () => {
                if (controlCenter.classList.contains('hidden')) {
                    controlCenter.classList.remove('hidden');
                } else {
                    controlCenter.classList.add('hidden');
                }
            });
        }
        
        if (controlCenterClose) {
            controlCenterClose.addEventListener('click', () => {
                controlCenter.classList.add('hidden');
            });
        }
        
        // Module System Implementation
        const moduleState = {};
        let nextModuleZIndex = 100;
        
        // Module toggle button handlers
        document.querySelectorAll('.module-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const moduleName = btn.dataset.module;
                toggleModule(moduleName);
                btn.classList.toggle('active');
            });
        });
        
        function toggleModule(moduleName) {
            const existingModule = document.getElementById(`module-${moduleName}`);
            
            if (existingModule) {
                // Module exists, toggle visibility
                if (existingModule.classList.contains('hidden')) {
                    existingModule.classList.remove('hidden');
                    existingModule.style.zIndex = ++nextModuleZIndex;
                } else {
                    existingModule.classList.add('hidden');
                }
            } else {
                // Create new module
                createModule(moduleName);
            }
        }
        
        function createModule(moduleName) {
            const moduleElement = document.createElement('div');
            moduleElement.id = `module-${moduleName}`;
            moduleElement.className = 'module-window';
            moduleElement.style.zIndex = ++nextModuleZIndex;
            
            // Set initial position (staggered)
            const offset = Object.keys(moduleState).length * 30;
            moduleElement.style.left = (100 + offset) + 'px';
            moduleElement.style.top = (150 + offset) + 'px';
            moduleElement.style.width = '400px';
            moduleElement.style.height = '500px';
            
            const moduleConfig = getModuleConfig(moduleName);
            
            moduleElement.innerHTML = `
                <div class="module-header" data-module="${moduleName}">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <span class="icon">${moduleConfig.icon}</span>
                        ${moduleConfig.title}
                    </h3>
                    <div class="module-controls">
                        <button class="collapse-btn" title="Collapse/Expand" aria-label="Collapse or expand module">
                            <span>‚àí</span>
                        </button>
                        <button class="close-btn" title="Close module" aria-label="Close module">
                            <span>√ó</span>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    ${getModuleContent(moduleName)}
                </div>
                <!-- Resize Handles -->
                <div class="resize-handle resize-handle-n" data-direction="n"></div>
                <div class="resize-handle resize-handle-s" data-direction="s"></div>
                <div class="resize-handle resize-handle-e" data-direction="e"></div>
                <div class="resize-handle resize-handle-w" data-direction="w"></div>
                <div class="resize-handle resize-handle-ne" data-direction="ne"></div>
                <div class="resize-handle resize-handle-nw" data-direction="nw"></div>
                <div class="resize-handle resize-handle-se" data-direction="se"></div>
                <div class="resize-handle resize-handle-sw" data-direction="sw"></div>
            `;
            
            // Store module state BEFORE setting up handlers
            moduleState[moduleName] = {
                element: moduleElement,
                collapsed: false,
                position: { x: 100 + offset, y: 150 + offset },
                size: { width: 400, height: 500 },
                cleanup: null
            };
            
            // Add to canvas area
            document.querySelector('#battle-canvas').parentElement.appendChild(moduleElement);
            
            // Setup module functionality (after state is initialized)
            setupModuleHandlers(moduleElement, moduleName);
        }
        
        function getModuleConfig(moduleName) {
            const configs = {
                party: { icon: 'üë•', title: 'Party Manager' },
                initiative: { icon: '‚ö°', title: 'Initiative Tracker' },
                tokens: { icon: 'üé®', title: 'Token Maker' },
                maps: { icon: 'üó∫Ô∏è', title: 'Maps Manager' },
                tools: { icon: 'üõ†Ô∏è', title: 'Tool Selection' },
                chat: { icon: 'üí¨', title: 'Chat Messages' },
                dice: { icon: 'üé≤', title: 'Dice Roller' }
            };
            return configs[moduleName] || { icon: '‚ùì', title: 'Module' };
        }
        
        function getModuleContent(moduleName) {
            switch (moduleName) {
                case 'party':
                    return generatePartyPanel();
                case 'initiative':
                    return generateInitiativePanel();
                case 'tokens':
                    return generateTokenMakerPanel();
                case 'maps':
                    return generateMapsPanel();
                case 'tools':
                    return generateToolsContent();
                case 'chat':
                    return generateChatContent();
                case 'dice':
                    return generateDiceContent();
                default:
                    return '<div class="text-white">Module content not implemented yet.</div>';
            }
        }
        
        function generateToolsContent() {
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-green-400">Tool Selection</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="btn-tool control-tool-btn ${appState.currentTool === 'move' ? 'active' : ''}" data-tool="move">
                            <span class="icon">‚¨ÖÔ∏è</span> Move
                        </button>
                        <button class="btn-tool control-tool-btn ${appState.currentTool === 'ruler' ? 'active' : ''}" data-tool="ruler">
                            <span class="icon">üìè</span> Ruler
                        </button>
                        <button class="btn-tool control-tool-btn ${appState.currentTool === 'fog' ? 'active' : ''}" data-tool="fog">
                            <span class="icon">üëÅÔ∏è</span> Fog
                        </button>
                        <button class="btn-tool control-tool-btn ${appState.currentTool === 'token' ? 'active' : ''}" data-tool="token">
                            <span class="icon">üë•</span> Token
                        </button>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-green-400 mt-4">Quick Actions</h4>
                    <div class="space-y-2">
                        <button id="module-create-token" class="btn-primary w-full">
                            <span class="icon">‚ûï</span> Create Token
                        </button>
                        <button id="module-toggle-fog" class="btn-secondary w-full">
                            <span class="icon">üëÅÔ∏è</span> Toggle Fog Mode
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateChatContent() {
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-green-400">Chat Messages</h4>
                    <div id="module-chat-messages" class="control-chat-messages">
                        <div class="text-gray-400 text-xs mb-2">Welcome to The Dragon Stones!</div>
                        <div class="text-green-400 text-xs">System: Modular interface active.</div>
                    </div>
                    
                    <div class="flex gap-2">
                        <input 
                            id="module-chat-input" 
                            type="text" 
                            placeholder="Type message or /roll 1d20..." 
                            class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm"
                            aria-label="Chat message input"
                        >
                        <button id="module-send-chat" class="btn-secondary" aria-label="Send chat message">
                            <span class="icon">üì§</span>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateDiceContent() {
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-green-400">Dice Roller</h4>
                    
                    <!-- Custom Dice Input -->
                    <div class="space-y-2">
                        <label class="text-sm text-gray-300">Custom Roll:</label>
                        <div class="flex gap-2">
                            <input 
                                id="module-custom-dice-input" 
                                type="text" 
                                placeholder="e.g., 2d6+3, 1d20+5" 
                                class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm"
                            >
                            <button id="module-roll-custom" class="btn-primary" aria-label="Roll custom dice formula">
                                <span class="icon">üé≤</span> Roll
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Dice -->
                    <div class="space-y-2">
                        <label class="text-sm text-gray-300">Quick Dice:</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="module-dice-btn" data-dice="d4">d4</button>
                            <button class="module-dice-btn" data-dice="d6">d6</button>
                            <button class="module-dice-btn" data-dice="d8">d8</button>
                            <button class="module-dice-btn" data-dice="d10">d10</button>
                            <button class="module-dice-btn" data-dice="d12">d12</button>
                            <button class="module-dice-btn" data-dice="d20">d20</button>
                        </div>
                    </div>
                    
                    <!-- Recent Rolls -->
                    <div class="space-y-2">
                        <label class="text-sm text-gray-300">Recent Rolls:</label>
                        <div id="module-recent-rolls" class="module-recent-rolls max-h-32 overflow-y-auto bg-gray-700 rounded p-2">
                            <!-- Recent rolls will appear here -->
                        </div>
                    </div>
                </div>
            `;
        }
        
        function setupModuleHandlers(moduleElement, moduleName) {
            const header = moduleElement.querySelector('.module-header');
            const collapseBtn = moduleElement.querySelector('.collapse-btn');
            const closeBtn = moduleElement.querySelector('.close-btn');
            const content = moduleElement.querySelector('.module-content');
            
            // Module-specific event handlers
            setupModuleSpecificHandlers(moduleElement, moduleName);
            
            // Collapse/expand functionality
            collapseBtn.addEventListener('click', () => {
                moduleElement.classList.toggle('collapsed');
                if (moduleState[moduleName]) {
                    moduleState[moduleName].collapsed = !moduleState[moduleName].collapsed;
                    collapseBtn.querySelector('span').textContent = moduleState[moduleName].collapsed ? '+' : '‚àí';
                }
            });
            
            // Close functionality
            closeBtn.addEventListener('click', () => {
                moduleElement.classList.add('hidden');
                // Update toggle button state
                const toggleBtn = document.querySelector(`[data-module="${moduleName}"]`);
                if (toggleBtn) {
                    toggleBtn.classList.remove('active');
                }
            });
            
            // Dragging functionality
            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let moduleStartX = 0;
            let moduleStartY = 0;
            // Fixed: Cache dimensions to prevent drag-and-drop positioning issues
            let moduleStartWidth = 0;
            let moduleStartHeight = 0;
            
            header.addEventListener('mousedown', (e) => {
                // Don't start dragging if clicking on control buttons
                if (e.target.closest('.module-controls')) {
                    return;
                }
                
                isDragging = true;
                moduleElement.classList.add('dragging');
                moduleElement.style.zIndex = ++nextModuleZIndex;
                
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                // FIXED: Use current CSS position values instead of getBoundingClientRect()
                // to prevent coordinate system mismatch causing jump behavior
                moduleStartX = parseInt(moduleElement.style.left) || 0;
                moduleStartY = parseInt(moduleElement.style.top) || 0;
                
                const rect = moduleElement.getBoundingClientRect();
                moduleStartWidth = rect.width;
                moduleStartHeight = rect.height;
                
                e.preventDefault();
            });
            
            // Resizing functionality
            const resizeHandles = moduleElement.querySelectorAll('.resize-handle');
            let isResizing = false;
            let resizeStartX = 0;
            let resizeStartY = 0;
            let currentResizeDirection = null;
            
            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    moduleElement.classList.add('resizing');
                    moduleElement.style.zIndex = ++nextModuleZIndex;
                    currentResizeDirection = handle.dataset.direction;
                    
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    
                    const rect = moduleElement.getBoundingClientRect();
                    moduleStartX = rect.left;
                    moduleStartY = rect.top;
                    moduleStartWidth = rect.width;
                    moduleStartHeight = rect.height;
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // Global mouse move handler for this module
            const mouseMoveHandler = (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;
                    
                    const newX = moduleStartX + deltaX;
                    const newY = moduleStartY + deltaY;
                    
                    // Keep module within viewport bounds
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    // FIXED: Use cached dimensions instead of recalculating getBoundingClientRect()
                    // during drag operation to prevent incorrect drop positioning.
                    const clampedX = Math.max(0, Math.min(newX, viewportWidth - moduleStartWidth));
                    const clampedY = Math.max(0, Math.min(newY, viewportHeight - moduleStartHeight));
                    
                    moduleElement.style.left = clampedX + 'px';
                    moduleElement.style.top = clampedY + 'px';
                    
                    // Update state (with error checking)
                    if (moduleState[moduleName]) {
                        moduleState[moduleName].position = { x: clampedX, y: clampedY };
                    }
                }
                
                if (isResizing && currentResizeDirection) {
                    const deltaX = e.clientX - resizeStartX;
                    const deltaY = e.clientY - resizeStartY;
                    
                    let newWidth = moduleStartWidth;
                    let newHeight = moduleStartHeight;
                    let newX = moduleStartX;
                    let newY = moduleStartY;
                    
                    if (currentResizeDirection.includes('e')) {
                        newWidth = Math.max(280, moduleStartWidth + deltaX);
                    }
                    if (currentResizeDirection.includes('w')) {
                        newWidth = Math.max(280, moduleStartWidth - deltaX);
                        newX = moduleStartX + deltaX;
                        if (newWidth === 280) newX = moduleStartX + moduleStartWidth - 280;
                    }
                    if (currentResizeDirection.includes('s')) {
                        newHeight = Math.max(200, moduleStartHeight + deltaY);
                    }
                    if (currentResizeDirection.includes('n')) {
                        newHeight = Math.max(200, moduleStartHeight - deltaY);
                        newY = moduleStartY + deltaY;
                        if (newHeight === 200) newY = moduleStartY + moduleStartHeight - 200;
                    }
                    
                    // Apply constraints
                    const maxWidth = Math.min(600, window.innerWidth - newX);
                    const maxHeight = Math.min(800, window.innerHeight - newY);
                    
                    newWidth = Math.min(newWidth, maxWidth);
                    newHeight = Math.min(newHeight, maxHeight);
                    
                    moduleElement.style.left = newX + 'px';
                    moduleElement.style.top = newY + 'px';
                    moduleElement.style.width = newWidth + 'px';
                    moduleElement.style.height = newHeight + 'px';
                    
                    // Update state (with error checking)
                    if (moduleState[moduleName]) {
                        moduleState[moduleName].position = { x: newX, y: newY };
                        moduleState[moduleName].size = { width: newWidth, height: newHeight };
                    }
                }
            };
            
            const mouseUpHandler = () => {
                if (isDragging) {
                    isDragging = false;
                    moduleElement.classList.remove('dragging');
                }
                if (isResizing) {
                    isResizing = false;
                    moduleElement.classList.remove('resizing');
                    currentResizeDirection = null;
                }
            };
            
            // Add global listeners for this module
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            
            // Store cleanup function (with error checking)
            if (moduleState[moduleName]) {
                moduleState[moduleName].cleanup = () => {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                };
            }
        }
        
        function setupModuleSpecificHandlers(moduleElement, moduleName) {
            // Setup handlers specific to each module type
            switch (moduleName) {
                case 'party':
                    setupModulePartyHandlers(moduleElement);
                    break;
                case 'initiative':
                    setupModuleInitiativeHandlers(moduleElement);
                    break;
                case 'tokens':
                    setupModuleTokenHandlers(moduleElement);
                    break;
                case 'maps':
                    setupModuleMapsHandlers(moduleElement);
                    break;
                case 'tools':
                    setupToolsHandlers(moduleElement);
                    break;
                case 'chat':
                    setupChatHandlers(moduleElement);
                    break;
                case 'dice':
                    setupDiceHandlers(moduleElement);
                    break;
            }
        }
        
        function setupToolsHandlers(moduleElement) {
            // Tool selection buttons
            moduleElement.querySelectorAll('.control-tool-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tool = btn.dataset.tool;
                    selectTool(tool);
                    
                    // Update button states in module
                    moduleElement.querySelectorAll('.control-tool-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // Quick action buttons
            const createTokenBtn = moduleElement.querySelector('#module-create-token');
            const toggleFogBtn = moduleElement.querySelector('#module-toggle-fog');
            
            if (createTokenBtn) {
                createTokenBtn.addEventListener('click', () => {
                    // Reuse existing create token functionality
                    if (typeof createToken === 'function') {
                        createToken();
                    }
                });
            }
            
            if (toggleFogBtn) {
                toggleFogBtn.addEventListener('click', () => {
                    // Toggle fog mode
                    selectTool('fog');
                });
            }
        }
        
        function setupChatHandlers(moduleElement) {
            const chatInput = moduleElement.querySelector('#module-chat-input');
            const sendBtn = moduleElement.querySelector('#module-send-chat');
            const messagesDiv = moduleElement.querySelector('#module-chat-messages');
            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (message) {
                    addChatMessage(message, 'player');
                    chatInput.value = '';
                    
                    // Update messages in module
                    if (messagesDiv) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'text-white text-xs mb-1';
                        messageDiv.textContent = `Player: ${message}`;
                        messagesDiv.appendChild(messageDiv);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        }
        
        function setupDiceHandlers(moduleElement) {
            const customDiceInput = moduleElement.querySelector('#module-custom-dice-input');
            const rollCustomBtn = moduleElement.querySelector('#module-roll-custom');
            const recentRollsDiv = moduleElement.querySelector('#module-recent-rolls');
            
            // Quick dice buttons
            moduleElement.querySelectorAll('.module-dice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const diceType = btn.dataset.dice;
                    const result = rollDice(`1${diceType}`);
                    if (recentRollsDiv && result) {
                        addRollToModule(recentRollsDiv, `1${diceType}`, result);
                    }
                });
            });
            
            // Custom dice roll
            function rollCustomDice() {
                const formula = customDiceInput.value.trim();
                if (formula) {
                    const result = rollDice(formula);
                    if (recentRollsDiv && result) {
                        addRollToModule(recentRollsDiv, formula, result);
                    }
                    customDiceInput.value = '';
                }
            }
            
            if (rollCustomBtn) {
                rollCustomBtn.addEventListener('click', rollCustomDice);
            }
            
            if (customDiceInput) {
                customDiceInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        rollCustomDice();
                    }
                });
            }
        }
        
        function addRollToModule(recentRollsDiv, formula, result) {
            const rollDiv = document.createElement('div');
            rollDiv.className = 'text-white text-xs mb-1';
            rollDiv.textContent = `${formula}: ${result}`;
            recentRollsDiv.appendChild(rollDiv);
            recentRollsDiv.scrollTop = recentRollsDiv.scrollHeight;
            
            // Keep only last 10 rolls
            while (recentRollsDiv.children.length > 10) {
                recentRollsDiv.removeChild(recentRollsDiv.firstChild);
            }
        }
        
        function setupModulePartyHandlers(moduleElement) {
            // Setup party-specific handlers within the module
            const addBtn = moduleElement.querySelector('#add-party-member');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    addPartyMember();
                });
            }
        }
        
        function setupModuleInitiativeHandlers(moduleElement) {
            // Setup initiative-specific handlers within the module  
            const initBtn = moduleElement.querySelector('#roll-initiative');
            if (initBtn) {
                initBtn.addEventListener('click', () => {
                    rollInitiative();
                });
            }
        }
        
        function setupModuleTokenHandlers(moduleElement) {
            // Setup token-specific handlers within the module
            const createBtn = moduleElement.querySelector('#create-token-btn');
            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    createToken();
                });
            }
        }
        
        function setupModuleMapsHandlers(moduleElement) {
            // Setup map-specific handlers within the module
            const createMapBtn = moduleElement.querySelector('#create-sub-map');
            if (createMapBtn) {
                createMapBtn.addEventListener('click', () => {
                    createSubMap();
                });
            }
        }
        
        // Panel Event Listeners (keeping existing functionality)
        document.querySelectorAll('#sidebar-panel .btn-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelName = tab.dataset.panel;
                if (panelName) {
                    showPanel(panelName);
                }
            });
        });
        

        // Module system implementation complete

        // Control Center Dragging functionality
        if (controlCenterHeader) {
            controlCenterHeader.addEventListener('mousedown', (e) => {
                // Don't start dragging if clicking on the close button
                if (e.target === controlCenterClose || controlCenterClose.contains(e.target)) {
                    return;
                }
                
                if (e.target === controlCenterHeader || controlCenterHeader.contains(e.target)) {
                    isControlCenterDragging = true;
                    controlCenter.classList.add('dragging');
                    
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    
                    const rect = controlCenter.getBoundingClientRect();
                    windowStartX = rect.left;
                    windowStartY = rect.top;
                    
                    e.preventDefault();
                }
            });
        }
        
        // Resize functionality
        resizeHandles.forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                controlCenter.classList.add('resizing');
                currentResizeHandle = handle.dataset.direction;
                
                resizeStartX = e.clientX;
                resizeStartY = e.clientY;
                
                const rect = controlCenter.getBoundingClientRect();
                windowStartX = rect.left;
                windowStartY = rect.top;
                windowStartWidth = rect.width;
                windowStartHeight = rect.height;
                
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        // Mouse move handler for both drag and resize
        document.addEventListener('mousemove', (e) => {
            if (isControlCenterDragging) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                const newX = windowStartX + deltaX;
                const newY = windowStartY + deltaY;
                
                // Keep window within viewport bounds
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const windowRect = controlCenter.getBoundingClientRect();
                
                const clampedX = Math.max(0, Math.min(newX, viewportWidth - windowRect.width));
                const clampedY = Math.max(0, Math.min(newY, viewportHeight - windowRect.height));
                
                controlCenter.style.left = clampedX + 'px';
                controlCenter.style.top = clampedY + 'px';
                controlCenter.style.right = 'auto';
                controlCenter.style.bottom = 'auto';
            }
            
            if (isResizing && currentResizeHandle) {
                const deltaX = e.clientX - resizeStartX;
                const deltaY = e.clientY - resizeStartY;
                
                let newWidth = windowStartWidth;
                let newHeight = windowStartHeight;
                let newX = windowStartX;
                let newY = windowStartY;
                
                // Handle different resize directions
                if (currentResizeHandle.includes('e')) {
                    newWidth = Math.max(280, windowStartWidth + deltaX);
                }
                if (currentResizeHandle.includes('w')) {
                    const widthChange = Math.min(deltaX, windowStartWidth - 280);
                    newWidth = windowStartWidth - widthChange;
                    newX = windowStartX + widthChange;
                }
                if (currentResizeHandle.includes('s')) {
                    newHeight = Math.max(200, windowStartHeight + deltaY);
                }
                if (currentResizeHandle.includes('n')) {
                    const heightChange = Math.min(deltaY, windowStartHeight - 200);
                    newHeight = windowStartHeight - heightChange;
                    newY = windowStartY + heightChange;
                }
                
                // Apply constraints
                const maxWidth = Math.min(600, window.innerWidth - newX);
                const maxHeight = Math.min(window.innerHeight * 0.8, window.innerHeight - newY);
                
                newWidth = Math.min(newWidth, maxWidth);
                newHeight = Math.min(newHeight, maxHeight);
                
                // Update window position and size
                controlCenter.style.left = newX + 'px';
                controlCenter.style.top = newY + 'px';
                controlCenter.style.width = newWidth + 'px';
                controlCenter.style.height = newHeight + 'px';
                controlCenter.style.right = 'auto';
                controlCenter.style.bottom = 'auto';
            }
        });
        
        // Mouse up handler
        document.addEventListener('mouseup', () => {
            if (isControlCenterDragging) {
                isControlCenterDragging = false;
                controlCenter.classList.remove('dragging');
            }
            if (isResizing) {
                isResizing = false;
                controlCenter.classList.remove('resizing');
                currentResizeHandle = null;
            }
        });
        
        // Prevent text selection during drag/resize
        document.addEventListener('selectstart', (e) => {
            if (isControlCenterDragging || isResizing) {
                e.preventDefault();
            }
        });
        
        // Initialize application
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        updateZoomDisplay();
        setupUploadHandlers();
        setupModalHandlers();
        
        // Initialize panel system
        showPanel('party');
        
        // Welcome message
        setTimeout(() => {
            addChatMessage('Welcome to The Dragon Stones battle map! Now with enhanced BattleGrounds features.', 'system');
            addChatMessage('Use the left sidebar for Party Manager, Initiative Tracker, Dice Roller, and Token Maker.', 'system');
            addChatMessage('Try the enhanced Fog of War tool with brush, cone, and circle modes.', 'system');
        }, 1000);
    </script>
</body>
</html>